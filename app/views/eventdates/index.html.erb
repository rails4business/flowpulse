<% content_for :title, "Agenda" %>
<% content_for :head do %>
  <%= render "shared/tailwind_head" %>
<% end %>

<div class="w-full max-w-[960px] mx-auto px-4 sm:px-10 py-8 flex flex-col gap-8">
  <% if notice.present? %>
    <p class="py-2 px-3 bg-green-50 text-green-600 font-medium rounded-md inline-block" id="notice">
      <%= notice %>
    </p>
  <% end %>

  <section class="flex flex-col md:flex-row md:items-end justify-between gap-6 pb-2">
    <div class="flex flex-col gap-2">
      <h1 class="text-[#111318] dark:text-white text-[32px] font-bold leading-tight tracking-tight">Agenda</h1>
      <p class="text-[#636f88] dark:text-gray-400 text-sm font-normal leading-relaxed">
        Filtra per data, tipo evento e taxbranch per vedere lâ€™agenda.
      </p>
    </div>
    <div class="flex gap-3">
      <%= link_to "+ Evento rapido",
            new_eventdate_path,
            class: "flex items-center justify-center rounded-lg h-10 px-4 bg-white dark:bg-[#1a2233] border border-[#e5e7eb] dark:border-gray-700 text-[#111318] dark:text-white hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors text-sm font-medium shadow-sm" %>
    </div>
  </section>

  <section class="bg-white dark:bg-[#1a2233] rounded-2xl border border-[#e5e7eb] dark:border-gray-800 shadow-sm p-5 space-y-4">
    <%= form_with url: eventdates_path, method: :get, local: true, class: "grid gap-4 md:grid-cols-4" do |f| %>
      <div class="md:col-span-1">
        <label class="block text-xs font-semibold text-[#636f88] dark:text-gray-400 mb-1">ğŸ“† Giorno agenda</label>
        <%= f.date_field :on,
              value: (@date&.to_date || nil),
              class: "block w-full rounded-lg border border-[#e5e7eb] dark:border-gray-700 bg-white dark:bg-[#111621] px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" %>
        <%= hidden_field_tag :event_type, (@event_type_filter unless @event_type_filter == "all") %>
      </div>
      <div class="md:col-span-2">
        <label class="block text-xs font-semibold text-[#636f88] dark:text-gray-400 mb-1">ğŸ·ï¸ Taxbranch</label>
        <%= hidden_field_tag :taxbranch_id, @selected_taxbranch&.id, id: "taxbranch-id-field" %>
        <%= text_field_tag :taxbranch_query,
              @selected_taxbranch&.display_label,
              list: "taxbranch-options",
              placeholder: "Scrivi per filtrare",
              autocomplete: "off",
              class: "block w-full rounded-lg border border-[#e5e7eb] dark:border-gray-700 bg-white dark:bg-[#111621] px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent",
              id: "taxbranch-query-field" %>
        <datalist id="taxbranch-options">
          <option value="" data-id="">Tutti</option>
          <% @taxbranches.each do |tb| %>
            <option value="<%= tb.display_label %>" data-id="<%= tb.id %>"></option>
          <% end %>
        </datalist>
      </div>
      <div class="flex items-end gap-3 md:justify-end">
        <%= link_to "Reset",
            eventdates_path,
            class: "inline-flex items-center rounded-lg border border-[#e5e7eb] dark:border-gray-700 px-3 py-2 text-sm font-semibold text-[#636f88] dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-800" %>
        <%= f.submit "Filtra",
              class: "inline-flex items-center rounded-lg bg-[#111318] px-4 py-2 text-white text-sm font-semibold shadow-sm hover:bg-black" %>
      </div>
    <% end %>
  </section>

  <section class="space-y-4">
    <div class="flex items-center justify-between">
      <h2 class="text-[#111318] dark:text-white text-xl font-bold tracking-tight">Agenda del giorno</h2>
      <% if @date %>
        <span class="text-xs text-[#636f88] dark:text-gray-400">
          <%= l(@date.to_date, format: :long) rescue @date %>
        </span>
      <% end %>
    </div>

    <% if @date && @agenda_eventdates.any? %>
      <div class="rounded-2xl border border-[#e5e7eb] dark:border-gray-800 bg-white dark:bg-[#1a2233] shadow-sm divide-y divide-slate-100 dark:divide-gray-800">
        <% @agenda_eventdates.each do |eventdate| %>
          <div class="px-5 py-4 flex flex-col gap-1 md:flex-row md:items-center md:justify-between">
            <div class="flex items-center gap-4">
              <div class="text-center px-3 py-2 rounded-xl bg-[#f6f6f8] dark:bg-[#111621] border border-[#e5e7eb] dark:border-gray-800">
                <div class="text-xl font-bold text-[#111318] dark:text-white">
                  <%= eventdate.date_start ? l(eventdate.date_start, format: "%d") : "--" %>
                </div>
                <div class="text-[11px] uppercase tracking-wide text-[#636f88] dark:text-gray-400">
                  <%= eventdate.date_start ? l(eventdate.date_start, format: "%b") : "" %>
                </div>
              </div>
              <div>
                <p class="font-semibold text-[#111318] dark:text-white">
                  <%= link_to eventdate_label(eventdate), eventdate_path(eventdate), class: "hover:text-blue-600" %>
                </p>
                <p class="text-xs text-[#636f88] dark:text-gray-400">
                  <% if eventdate.date_start.present? %>
                    <strong><%= l(eventdate.date_start, format: :time) %></strong>
                  <% end %>
                  <% if eventdate.date_end.present? %>
                    â€“ <strong><%= l(eventdate.date_end, format: :time) %></strong>
                  <% end %>
                </p>
                <% if eventdate.location.present? %>
                  <p class="text-xs text-[#636f88] dark:text-gray-400">ğŸ“ <%= eventdate.location %></p>
                <% end %>
              </div>
            </div>
            <div class="flex flex-wrap gap-2 text-xs text-[#636f88] dark:text-gray-300">
              <%= link_to "Apri",
                  eventdate_path(eventdate),
                  class: "inline-flex items-center rounded-lg border border-[#e5e7eb] dark:border-gray-700 bg-white dark:bg-[#111621] px-3 py-1.5 font-semibold hover:bg-gray-50 dark:hover:bg-gray-800" %>
              <%= link_to "Nuovo booking",
                  new_booking_path(eventdate_id: eventdate.id),
                  class: "inline-flex items-center rounded-lg border border-emerald-200 bg-emerald-50 px-3 py-1.5 font-semibold text-emerald-700 hover:bg-emerald-100" %>
            </div>
          </div>
        <% end %>
      </div>
    <% elsif @date %>
      <p class="text-sm text-[#636f88] dark:text-gray-400 text-center py-6">
        Nessun evento in agenda per questo giorno.
      </p>
    <% else %>
      <p class="text-sm text-[#636f88] dark:text-gray-400">
        Seleziona una data dal filtro per vedere lâ€™agenda giornaliera.
      </p>
    <% end %>
  </section>

  <section class="space-y-4">
    <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between border-b border-[#e5e7eb] dark:border-gray-800 pb-3">
      <div class="text-sm text-[#636f88] dark:text-gray-400">Filtra per tipo evento</div>
      <nav class="flex flex-wrap gap-2 text-xs text-[#636f88] dark:text-gray-300">
        <% type_tabs = [["all", "Tutti i tipi"]] + Eventdate.event_types.keys.map { |key| [key, key.humanize] } %>
        <% type_tabs.each do |key, label| %>
          <% active = (@event_type_filter == key) %>
          <%= link_to label,
              eventdates_path(on: (@date&.to_s),
                              taxbranch_id: @selected_taxbranch&.id,
                              event_type: key == "all" ? nil : key),
              class: [
                "rounded-full px-3 py-1 border text-xs font-semibold",
                active ? "bg-[#111318] text-white border-[#111318]" : "border-[#e5e7eb] dark:border-gray-700 text-[#636f88] dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-800"
              ].join(" ") %>
        <% end %>
      </nav>
    </div>

    <div id="eventdates-tab-content">
      <% if @current_collection.any? %>
        <div class="flex flex-col gap-4">
          <%= render partial: "eventdates/list_row", collection: @current_collection, as: :eventdate %>
        </div>
      <% else %>
        <p class="text-sm text-[#636f88] dark:text-gray-400">
          Nessun evento disponibile per i filtri selezionati.
        </p>
      <% end %>
    </div>
  </section>
</div>

<%= javascript_tag do %>
  const setupTaxbranchAutocomplete = () => {
    const input = document.getElementById("taxbranch-query-field");
    const hidden = document.getElementById("taxbranch-id-field");
    if (!input || !hidden) return;

    const options = Array.from(document.querySelectorAll("#taxbranch-options option"));

    const syncHidden = () => {
      const value = input.value.trim();
      const match = options.find((option) => option.value === value);
      hidden.value = match && match.dataset.id ? match.dataset.id : "";
    };

    input.addEventListener("change", syncHidden);
    input.addEventListener("input", () => {
      if (!input.value) hidden.value = "";
    });
  };

  document.addEventListener("turbo:load", setupTaxbranchAutocomplete);
  document.addEventListener("DOMContentLoaded", setupTaxbranchAutocomplete);
<% end %>
