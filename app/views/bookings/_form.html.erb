<% eventdate = @eventdate || booking.eventdate %>
<% journey   = eventdate&.journey %>
<% commitments_scope =
     if eventdate.present?
       eventdate.commitments.ordered
     elsif journey.present?
       journey.commitments
     else
       Commitment.none
     end %>
<% selected_commitment = @commitment || booking.commitment %>
<% contacts_scope = Mycontact.includes(:datacontact).order(:created_at).limit(100) %>
<% selected_contact = booking.mycontact %>
<% services_scope = Service.order(:name) %>
<% selected_service = booking.service %>
<% datacontacts_scope = Datacontact.order(:first_name, :last_name).limit(100) %>

<%= form_with(model: booking, class: "space-y-8") do |form| %>
  <% if booking.errors.any? %>
    <div class="bg-red-50 border border-red-200 text-red-700 rounded-xl px-4 py-3">
      <p class="font-semibold text-sm">Risolvere <%= pluralize(booking.errors.count, "errore") %> per salvare il booking:</p>
      <ul class="mt-2 list-disc list-inside text-sm space-y-1">
        <% booking.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <section class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6 space-y-4">
    <div class="flex items-start justify-between">
      <div>
        <p class="text-xs uppercase tracking-widest text-slate-400">Booking</p>
        <h1 class="text-3xl font-bold text-slate-900"><%= booking.persisted? ? "Modifica partecipante" : "Nuovo partecipante" %></h1>
        <p class="text-sm text-slate-600">Invita un contatto all'evento e collega eventuale commitment.</p>
      </div>
      <% if eventdate %>
        <span class="inline-flex items-center rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-600">
          Evento ##<%= eventdate.id %>
        </span>
      <% end %>
    </div>

    <div class="grid gap-6 md:grid-cols-2">
      <div>
        <label class="block text-sm font-semibold text-slate-900 mb-2">Evento</label>
        <% if eventdate %>
          <%= form.hidden_field :eventdate_id, value: eventdate.id %>
          <div class="rounded-lg border border-slate-100 bg-slate-50 p-4 text-sm text-slate-700">
            <p class="font-semibold text-slate-900"><%= eventdate_label(eventdate) %></p>
            <p><%= eventdate_period(eventdate) %></p>
            <% if eventdate.location.present? %>
              <p class="text-xs text-slate-500 mt-1">üìç <%= eventdate.location %></p>
            <% end %>
          </div>
        <% else %>
          <%= form.collection_select :eventdate_id,
                Eventdate.where(lead: Current.user&.lead).order(date_start: :desc).limit(50),
                :id,
                ->(e) { "#{l(e.date_start, format: :short) rescue "-"} ¬∑ #{e.location.presence || "Senza location"}" },
                { include_blank: "Seleziona un evento" },
                class: "block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",
                required: true %>
        <% end %>
      </div>

      <div>
        <label class="block text-sm font-semibold text-slate-900 mb-2">Partecipante (Mycontact)</label>
        <% if contacts_scope.any? %>
          <%= form.collection_select :mycontact_id,
                contacts_scope,
                :id,
                ->(mc) { [
                    mc.datacontact&.full_name.presence || "Contatto ##{mc.id}",
                    mc.datacontact&.email
                  ].compact.join(" ¬∑ ") },
                { include_blank: "Seleziona un contatto" },
                class: "block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" %>
          <p class="text-xs text-slate-500 mt-1">
            Mostrati i pi√π recenti <%= contacts_scope.size %> contatti. <%= link_to "Gestisci rubrica", mycontacts_path, class: "text-blue-600 hover:underline" %>
          </p>
        <% else %>
          <p class="text-xs text-slate-500">
            Non ci sono contatti disponibili. <%= link_to "Aggiungi un contatto", new_mycontact_path, class: "text-blue-600 hover:underline" %>.
          </p>
        <% end %>
      </div>

      <div>
        <label class="block text-sm font-semibold text-slate-900 mb-2">Commitment collegato</label>
        <%= form.collection_select :commitment_id,
              commitments_scope,
              :id,
              ->(c) { c.role_name.presence || "Commitment ##{c.id}" },
              { include_blank: "Nessun commitment specifico", selected: selected_commitment&.id },
              class: "block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        <% if commitments_scope.none? %>
          <p class="text-xs text-slate-500 mt-1">Non ci sono commitment collegati a questo evento.</p>
        <% end %>
      </div>

      <div>
        <label class="block text-sm font-semibold text-slate-900 mb-2">Servizio (opzionale)</label>
        <%= form.hidden_field :service_id, value: selected_service&.id, id: "booking-service-id" %>
        <% if services_scope.any? %>
          <%= text_field_tag :service_query,
                selected_service&.name,
                list: "booking-service-options",
                placeholder: "Seleziona o cerca un servizio",
                autocomplete: "off",
                class: "block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",
                id: "booking-service-query" %>
          <datalist id="booking-service-options">
            <% services_scope.each do |service| %>
              <option value="<%= service.name %>" data-id="<%= service.id %>"></option>
            <% end %>
          </datalist>
        <% else %>
          <p class="text-xs text-slate-500">Nessun servizio configurato.</p>
        <% end %>
      </div>
    </div>
  </section>

  <section class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6 space-y-6">
    <div>
      <p class="text-xs uppercase tracking-widest text-slate-400">Stato & ruoli</p>
      <h2 class="text-xl font-semibold text-slate-900">Conferme e modalit√†</h2>
    </div>

    <div class="grid gap-6 md:grid-cols-3">
      <div>
        <label class="block text-sm font-semibold text-slate-900 mb-2">Stato</label>
        <%= form.select :status,
              Booking.statuses.keys.map { |s| [s.humanize, s] },
              {},
              class: "block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" %>
      </div>
      <div>
        <label class="block text-sm font-semibold text-slate-900 mb-2">Modalit√†</label>
        <%= form.select :mode,
              Booking.modes.keys.map { |m| [m.humanize, m] },
              {},
              class: "block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" %>
      </div>
      <div>
        <label class="block text-sm font-semibold text-slate-900 mb-2">Ruolo partecipante</label>
        <%= form.select :participant_role,
              Booking.participant_roles.keys.map { |r| [r.humanize, r] },
              {},
              class: "block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" %>
      </div>
    </div>

    <div class="grid gap-6 md:grid-cols-2">
      <div>
        <label class="block text-sm font-semibold text-slate-900 mb-2">Richiesto da lead</label>
        <%= form.collection_select :requested_by_lead_id,
              datacontacts_scope,
              :id,
              ->(c) { c.full_name.presence || "Lead ##{c.id}" },
              { include_blank: "Nessuno" },
              class: "block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" %>
      </div>
      <div>
        <label class="block text-sm font-semibold text-slate-900 mb-2">Invitato da lead</label>
        <%= form.collection_select :invited_by_lead_id,
              datacontacts_scope,
              :id,
              ->(c) { c.full_name.presence || "Lead ##{c.id}" },
              { include_blank: "Nessuno" },
              class: "block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" %>
      </div>
    </div>
  </section>

  <section class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6 space-y-6">
    <div>
      <p class="text-xs uppercase tracking-widest text-slate-400">Prezzi & note</p>
      <h2 class="text-xl font-semibold text-slate-900">Dettagli economici</h2>
    </div>

    <div class="grid gap-6 md:grid-cols-2">
      <div>
        <label class="block text-sm font-semibold text-slate-900 mb-2">Prezzo in euro</label>
        <div class="relative">
          <span class="absolute left-3 top-2 text-slate-400">‚Ç¨</span>
          <%= form.number_field :price_euro,
                min: 0,
                step: 0.01,
                placeholder: "es. 49.00",
                class: "block w-full rounded-lg border border-slate-300 pl-7 pr-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>
      </div>
      <div>
        <label class="block text-sm font-semibold text-slate-900 mb-2">Prezzo in Dash</label>
        <%= form.number_field :price_dash,
              min: 0,
              step: 0.00000001,
              placeholder: "es. 2.5",
              class: "block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" %>
      </div>
      <div class="md:col-span-2">
        <label class="block text-sm font-semibold text-slate-900 mb-2">Note</label>
        <%= form.text_area :notes,
              rows: 4,
              placeholder: "Annota esigenze particolari, pagamenti previsti o altre informazioni",
              class: "block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" %>
      </div>
    </div>
  </section>

  <div class="flex flex-wrap gap-3 justify-end">
    <%= link_to "Annulla",
          eventdate ? eventdate_path(eventdate) : bookings_path,
          class: "inline-flex items-center rounded-lg border border-slate-300 bg-white px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-50" %>
    <%= form.submit (booking.persisted? ? "Aggiorna booking" : "Crea booking"),
          class: "inline-flex items-center rounded-lg bg-blue-600 px-6 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500" %>
  </div>
<% end %>

<%= javascript_tag do %>
  const initBookingForm = () => {
    document.querySelectorAll('[data-slider-target]').forEach((slider) => {
      const targetId = slider.dataset.sliderTarget;
      const output = document.getElementById(targetId);
      if (!output) return;
      const update = () => { output.textContent = slider.value; };
      slider.addEventListener('input', update);
      update();
    });

    const setupDatalist = (inputId, hiddenId, optionsSelector) => {
      const input = document.getElementById(inputId);
      const hidden = document.getElementById(hiddenId);
      if (!input || !hidden) return;
      const options = Array.from(document.querySelectorAll(optionsSelector));
      const sync = () => {
        const match = options.find((opt) => opt.value === input.value.trim());
        hidden.value = match ? match.dataset.id : "";
      };
      input.addEventListener('change', sync);
      input.addEventListener('input', () => {
        if (!input.value) hidden.value = "";
      });
      sync();
    };

    setupDatalist('booking-contact-query', 'booking-contact-id', '#booking-contact-options option');
    setupDatalist('booking-service-query', 'booking-service-id', '#booking-service-options option');
  };

  document.addEventListener('turbo:load', initBookingForm);
  document.addEventListener('DOMContentLoaded', initBookingForm);
<% end %>
