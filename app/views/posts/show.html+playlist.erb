<% content_for :title, @post.title.presence || @taxbranch.slug_label %>

<body class="min-h-full bg-white text-slate-900 antialiased dark:bg-slate-950 dark:text-slate-100">
  <div class="mx-auto max-w-5xl px-4 sm:px-6 lg:px-8 py-10">
    <header class="mb-8">
      <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
        <div class="space-y-2">
          <p class="text-xs font-semibold uppercase tracking-wider text-primary">Playlist</p>
          <h1 class="text-3xl md:text-4xl font-bold"><%= @post.title.presence || @taxbranch.slug_label %></h1>
          <% if @post.description.present? %>
            <p class="text-slate-600 dark:text-slate-400 max-w-2xl"><%= @post.description %></p>
          <% end %>
        </div>
        <% if @post.horizontal_cover_url.present? || @post.thumb_url.present? %>
          <div class="w-full sm:w-64">
            <img
              src="<%= @post.horizontal_cover_url.presence || @post.thumb_url %>"
              alt="<%= @post.title %>"
              class="h-36 w-full rounded-2xl object-cover shadow-sm"
            >
          </div>
        <% end %>
      </div>
    </header>

    <main class="grid gap-8 lg:grid-cols-[minmax(0,1fr)_280px]">
      <section class="space-y-6">
        <% if @post.content_md.present? || (@post.respond_to?(:content) && @post.content.present?) %>
          <div class="prose prose-slate dark:prose-invert max-w-none">
            <%= render "posts/body" %>
          </div>
        <% end %>
      </section>

      <aside class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-800 dark:bg-slate-900">
        <h2 class="text-sm font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-300">
          Puntate
        </h2>

        <% children_scope = @taxbranch.children.ordered %>
        <% children_scope = children_scope.reorder(position: (@taxbranch.order_des ? :desc : :asc)) %>
        <% published = children_scope.select { |t|
             t.public_node? &&
             t.published_at.present? &&
             t.published_at <= Time.current &&
             t.post&.persisted? &&
             t.post&.title.present?
           } %>
        <% upcoming = children_scope.find { |t|
             t.public_node? &&
             t.scheduled_eventdate&.date_start.present? &&
             t.published_at.blank? &&
             t.post&.persisted? &&
             t.post&.title.present?
           } %>
        <% items = [] %>
        <% items << upcoming if upcoming.present? %>
        <% items.concat(published.reject { |t| t == upcoming }) %>

        <% if items.any? %>
          <ul class="mt-4 space-y-3">
            <% items.each do |child| %>
              <% child_post = child.post %>
              <% next unless child_post&.persisted? %>
              <% in_arrivo = (child == upcoming && !published.include?(child)) %>
              <% badge_text = in_arrivo ? "In Arrivo" : I18n.l(child.published_at, format: "%d %b %Y", locale: :it) %>
              <li>
                <%= link_to post_path(child_post), class: "block rounded-lg px-3 py-2 hover:bg-slate-50 dark:hover:bg-slate-800" do %>
                  <div class="flex gap-3">
                    <% if child_post.horizontal_cover_url.present? %>
                      <div class="w-20 h-14 rounded-md overflow-hidden bg-slate-200 dark:bg-slate-800 flex-shrink-0">
                        <img src="<%= child_post.horizontal_cover_url %>" alt="" class="w-full h-full object-cover">
                      </div>
                    <% end %>
                    <div class="min-w-0">
                      <div class="text-[10px] uppercase tracking-wider text-slate-400">
                        Puntata <%= child.position %> â€¢ <%= badge_text %>
                      </div>
                      <div class="truncate text-sm font-semibold text-slate-700 dark:text-slate-100">
                        <%= child_post.title.presence || child.slug_label %>
                      </div>
                    </div>
                  </div>
                <% end %>
              </li>
            <% end %>
          </ul>
        <% else %>
          <p class="mt-3 text-sm text-slate-500">Nessuna puntata disponibile.</p>
        <% end %>
      </aside>
    </main>
  </div>
</body>
