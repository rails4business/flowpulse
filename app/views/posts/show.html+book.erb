<%# app/views/posts/show.html+book.erb %>
<% content_for :title, @post.title.presence || "Indice del libro" %>

<%= render "shared/nav_partial_post" %>

<%
  taxbranch = @post.taxbranch
  children  = taxbranch&.children&.ordered || Taxbranch.none
  chapter_entries = children.includes(:post)
  summary_html   = markdown(@post.content_md.presence || @post.description.to_s)
  total_chapters = chapter_entries.count { |tb| tb.slug_category != "header_chapter_book" }

  domain         = Current.domain || taxbranch&.header_domain
  domain_name    = domain&.title.presence || domain&.host
  domain_home    = begin
                     domain ? root_url(host: domain.host) : root_path
                   rescue
                     root_path
                   end

  author_email =
    if @post.lead&.respond_to?(:user) && @post.lead.user&.respond_to?(:email)
      @post.lead.user.email.presence
    elsif @post.lead&.respond_to?(:email)
      @post.lead.email.presence
    end
%>

<body class="bg-slate-50 text-slate-800 antialiased px-4 sm:px-8 lg:px-0">
  <!-- HEADER -->
  <header class="mx-auto max-w-3xl lg:max-w-4xl px-4 sm:px-8 lg:px-0 py-8 space-y-4">
    <div class="space-y-2">
      <h1 class="text-3xl font-bold text-slate-900">
        <%= @post.title.presence || taxbranch&.display_label || "Libro" %>
      </h1>
      <% if @post.description.present? %>
        <p class="text-base text-slate-600 leading-relaxed">
          <%= @post.description %>
        </p>
      <% end %>
      <div class="text-sm text-slate-500">
        <span class="font-semibold text-slate-700"><%= @post.lead&.full_name || "Autore n/d" %></span>
        <% if author_email.present? %>
          · <%= author_email %>
        <% end %>
        · <%= pluralize(total_chapters, "capitolo") %>
      </div>
    </div>

    <div class="mt-4 flex flex-wrap items-center gap-3 no-print">
      <% if domain %>
        <%= link_to "↩︎ Torna a #{domain_name}",
                    domain_home,
                    class: "rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-100" %>
      <% end %>
      <button onclick="window.print()"
              class="rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800">
        Stampa / Salva PDF
      </button>
    </div>
  </header>

  <!-- SUMMARY -->
  <section class="mx-auto max-w-3xl lg:max-w-4xl px-4 sm:px-8 lg:px-0 pb-4">
    <div class="rounded-2xl bg-white border border-slate-200 shadow-sm p-6">
      <div class="space-y-3 text-sm text-slate-700 leading-relaxed">
        <%= summary_html %>
      </div>
    </div>
  </section>

  <!-- CONTENT -->
  <main class="mx-auto max-w-3xl lg:max-w-4xl px-4 sm:px-8 lg:px-0 pb-16 space-y-4">
    <% if chapter_entries.any? %>
      <% chapter_entries.each do |entry| %>
        <% if entry.slug_category == "header_chapter_book" %>
          <section class="pt-8 border-t border-slate-200">
            <h2 class="text-xl font-bold text-slate-900">
              <%= entry.slug_label.presence || entry.display_label || entry.post&.title || "Parte" %>
            </h2>
            <% description = entry.post&.description.presence || entry.notes %>
            <% if description.present? %>
              <p class="mt-1 text-slate-600 italic"><%= description %></p>
            <% end %>
          </section>
        <% else %>
          <% chapter_post = entry.post %>
          <article class="rounded-xl border border-slate-200 bg-white p-4 shadow-sm">
            <h3 class="text-sm font-semibold text-slate-900">
              <% if chapter_post.present? %>
                <%= link_to chapter_post.title.presence || entry.slug_label.presence || entry.display_label || "Capitolo",
                            post_entry_link(chapter_post, taxbranch: entry),
                            class: "hover:underline" %>
              <% else %>
                <%= entry.slug_label.presence || entry.display_label || "Capitolo" %>
              <% end %>
            </h3>
            <% if chapter_post&.description.present? %>
              <p class="mt-1 text-sm text-slate-600"><%= chapter_post.description %></p>
            <% end %>
          </article>
        <% end %>
      <% end %>
    <% else %>
      <section class="rounded-2xl border border-dashed border-slate-300 bg-white p-6 text-center text-slate-500">
        Nessun capitolo collegato al libro. Aggiungi taxbranch figli con categoria “chapter” o “chapter_header”.
      </section>
    <% end %>
  </main>

  <turbo-frame id="sheet_modal"></turbo-frame>
</body>
