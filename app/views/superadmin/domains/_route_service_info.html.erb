<% function_count = service.journeys.to_a.count(&:journey_function?) %>
<% active_template = service.journey_function_active_template %>
<% active_function = service.journey_function_active %>
<% selected_journey ||= nil %>
<% selected_journeys ||= {} %>
<% function_journeys ||= service.journeys.select(&:journey_function?) %>

<div class="px-2">
  <div class="rounded-lg border border-[#283039] bg-[#101922] p-3 space-y-3">
    <!-- Header: Count & Add Action -->
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-2">
        <span class="text-[10px] uppercase font-bold tracking-wider text-[#9dabb9]">Funzioni</span>
        <span class="flex h-5 w-5 items-center justify-center rounded-full bg-[#283039] text-[10px] font-bold text-white">
          <%= function_count %>
        </span>
      </div>
      <button
        type="button"
        class="text-[#9dabb9] hover:text-white transition-colors"
        data-modal-open="journey-function-<%= service.id %>"
        title="Nuova funzione"
      >
        <span class="material-symbols-outlined text-[18px]">add_circle</span>
      </button>
    </div>

    <!-- Active States -->
    <% if active_template.present? || active_function.present? %>
      <div class="space-y-2">
        <% if active_template.present? %>
          <% template_params = selected_journeys.merge(service.id.to_s => active_template.id).to_h %>
          <div class="flex items-center justify-between gap-2 rounded border border-blue-500/20 bg-blue-500/5 px-2 py-1.5">
            <div class="flex items-center gap-2 overflow-hidden">
              <span class="material-symbols-outlined text-[14px] text-blue-400">content_copy</span>
              <div class="flex flex-col min-w-0">
                <span class="text-[9px] uppercase font-semibold text-blue-300/70">Template Attivo</span>
                <%= link_to active_template.title.presence || active_template.slug,
                            testroute_superadmin_domain_path(domain, route: route, selected_journeys: template_params),
                            class: "truncate text-[11px] font-medium text-blue-100 hover:text-white hover:underline block" %>
              </div>
            </div>
          </div>
        <% end %>

        <% if active_function.present? %>
          <% active_params = selected_journeys.merge(service.id.to_s => active_function.id).to_h %>
          <div class="flex items-center justify-between gap-2 rounded border border-emerald-500/20 bg-emerald-500/5 px-2 py-1.5">
            <div class="flex items-center gap-2 overflow-hidden">
              <span class="material-symbols-outlined text-[14px] text-emerald-400">play_circle</span>
              <div class="flex flex-col min-w-0">
                <span class="text-[9px] uppercase font-semibold text-emerald-300/70">In Corso</span>
                <%= link_to active_function.title.presence || active_function.slug,
                            testroute_superadmin_domain_path(domain, route: route, selected_journeys: active_params),
                            class: "truncate text-[11px] font-medium text-emerald-100 hover:text-white hover:underline block" %>
              </div>
            </div>
            <%= link_to edit_journey_path(active_function),
                        data: { turbo_frame: "modal" },
                        class: "shrink-0 p-1 text-emerald-500/50 hover:text-emerald-400" do %>
              <span class="material-symbols-outlined text-[14px]">edit</span>
            <% end %>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="text-[10px] text-[#9dabb9] italic">Nessuna funzione attiva</p>
    <% end %>

    <!-- Selection Dropdown -->
    <% if function_journeys.any? %>
      <div class="pt-1 border-t border-[#283039]">
        <%= form_with url: testroute_superadmin_domain_path(domain), method: :get, local: true, class: "relative" do %>
          <%= hidden_field_tag :route, route if route.present? %>
          <% selected_journeys.each do |service_id, journey_id| %>
            <% next if service_id.to_s == service.id.to_s %>
            <%= hidden_field_tag "selected_journeys[#{service_id}]", journey_id %>
          <% end %>
          
          <div class="relative">
            <span class="pointer-events-none absolute left-2 top-1/2 -translate-y-1/2 material-symbols-outlined text-[14px] text-[#9dabb9]">history</span>
            <%= select_tag "selected_journeys[#{service.id}]",
                           options_for_select(
                             function_journeys.sort_by(&:updated_at).reverse.map { |j| 
                               label = j.title.presence || j.slug
                               label += " (Template)" if j.kind == "cycle_template"
                               [label, j.id] 
                             },
                             selected_journey&.id
                           ),
                           include_blank: "Seleziona altra funzione...",
                           class: "w-full appearance-none rounded bg-[#0f172a] border-0 ring-1 ring-[#283039] py-1.5 pl-8 pr-8 text-[11px] text-[#9dabb9] focus:ring-primary focus:text-white cursor-pointer",
                           onchange: "this.form.submit()" %>
             <span class="pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 material-symbols-outlined text-[14px] text-[#9dabb9]">expand_more</span>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<div class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 p-4" data-modal="journey-function-<%= service.id %>" role="dialog" aria-modal="true">
  <div class="w-full max-w-lg rounded-2xl border border-[#283039] bg-[#101922] p-6 shadow-2xl">
    <div class="flex items-start justify-between gap-4">
      <div>
        <h3 class="text-lg font-semibold text-white">Nuovo Journey function</h3>
        <p class="text-sm text-[#9dabb9] mt-1">
          Service: <%= service.name.presence || service.slug %>
        </p>
      </div>
      <button class="text-[#9dabb9] hover:text-white" type="button" data-modal-close="journey-function-<%= service.id %>">
        Chiudi
      </button>
    </div>

    <%= form_with model: Journey.new,
                  url: journeys_path,
                  method: :post,
                  class: "mt-4 space-y-3 text-sm" do |form| %>
      <%= form.hidden_field :taxbranch_id, value: service.taxbranch_id %>
      <%= form.hidden_field :service_id, value: service.id %>
      <%= form.hidden_field :kind, value: "process" %>
      <%= form.hidden_field :journey_type, value: "work" %>
      <%= form.hidden_field :journeys_status, value: "problema" %>
      <div class="grid gap-3 sm:grid-cols-2">
        <div>
          <%= form.label :start_at, "Start at", class: "block text-xs text-[#9dabb9] mb-1" %>
          <%= form.datetime_local_field :start_at,
                                        value: Time.current.strftime("%Y-%m-%dT%H:%M"),
                                        class: "w-full rounded-lg border border-[#283039] bg-[#0f172a] px-3 py-2 text-white focus:border-primary focus:ring-0" %>
        </div>
        <div>
          <%= form.label :end_at, "End at", class: "block text-xs text-[#9dabb9] mb-1" %>
          <%= form.datetime_local_field :end_at,
                                        class: "w-full rounded-lg border border-[#283039] bg-[#0f172a] px-3 py-2 text-white focus:border-primary focus:ring-0" %>
        </div>
      </div>

      <div>
        <%= form.label :title, "Titolo", class: "block text-xs text-[#9dabb9] mb-1" %>
        <%= form.text_field :title,
                            required: true,
                            class: "w-full rounded-lg border border-[#283039] bg-[#0f172a] px-3 py-2 text-white focus:border-primary focus:ring-0" %>
      </div>
      <div>
        <%= form.label :notes, "Note", class: "block text-xs text-[#9dabb9] mb-1" %>
        <%= form.text_area :notes,
                           rows: 3,
                           class: "w-full rounded-lg border border-[#283039] bg-[#0f172a] px-3 py-2 text-white focus:border-primary focus:ring-0" %>
      </div>
      <div class="grid gap-3 sm:grid-cols-3">
        <div>
          <%= form.label :kind, "Kind", class: "block text-xs text-[#9dabb9] mb-1" %>
          <%= form.select :kind,
                          Journey.kinds.keys,
                          { selected: "process" },
                          class: "w-full rounded-lg border border-[#283039] bg-[#0f172a] px-3 py-2 text-white" %>
        </div>
        <div>
          <%= form.label :journey_type, "Tipo", class: "block text-xs text-[#9dabb9] mb-1" %>
          <%= form.select :journey_type,
                          Journey.journey_types.keys,
                          { selected: "work" },
                          class: "w-full rounded-lg border border-[#283039] bg-[#0f172a] px-3 py-2 text-white" %>
        </div>
        <div>
          <%= form.label :journeys_status, "Fase", class: "block text-xs text-[#9dabb9] mb-1" %>
          <%= form.select :journeys_status,
                          Journey.journeys_statuses.keys,
                          { selected: "problema" },
                          class: "w-full rounded-lg border border-[#283039] bg-[#0f172a] px-3 py-2 text-white" %>
        </div>
      </div>
      <div>
        <%= form.label :journey_roles_text, "Ruoli (uno per riga)", class: "block text-xs text-[#9dabb9] mb-1" %>
        <%= form.text_area :journey_roles_text,
                           rows: 3,
                           class: "w-full rounded-lg border border-[#283039] bg-[#0f172a] px-3 py-2 text-white" %>
      </div>
      <div class="flex items-center justify-end gap-3 pt-2">
        <button type="button" class="rounded-lg border border-[#283039] px-4 py-2 text-xs font-semibold text-white hover:border-primary" data-modal-close="journey-function-<%= service.id %>">
          Annulla
        </button>
        <%= form.submit "Crea",
                        class: "inline-flex items-center rounded-lg bg-primary px-4 py-2 text-xs font-semibold text-white" %>
      </div>
    <% end %>
  </div>
</div>
