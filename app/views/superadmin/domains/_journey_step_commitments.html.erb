<% commitments = eventdate.commitments.ordered %>
<% modal_id = "commitment-eventdate-#{eventdate.id}" %>

<div class="mt-2 rounded-md border border-<%= tone %>-500/10 bg-[#0b1220] px-3 py-2 text-[11px] text-<%= tone %>-100/80">
  <div class="flex items-center justify-between gap-2">
    <span class="text-<%= tone %>-200/80 font-semibold">Commitments</span>
    <button type="button"
            class="text-<%= tone %>-200 hover:text-white"
            data-modal-open="<%= modal_id %>">
      +
    </button>
  </div>

  <% if commitments.any? %>
    <div class="mt-2 space-y-1">
      <% commitments.each do |commitment| %>
        <div class="flex items-center justify-between gap-2 rounded-md border border-<%= tone %>-500/10 bg-[#0f172a] px-2 py-1">
          <div class="min-w-0">
            <p class="truncate text-<%= tone %>-50 font-semibold">
              <%= commitment.role_name.presence || "Commitment ##{commitment.id}" %>
            </p>
            <p class="text-[10px] text-<%= tone %>-200/60">
              <%= commitment.commitment_kind&.humanize || "—" %>
              <% if commitment.area.present? %>
                · <%= commitment.area %>
              <% end %>
            </p>
          </div>
          <div class="text-[10px] text-<%= tone %>-200/60 text-right">
            <% if commitment.duration_minutes.present? %>
              <span><%= commitment.duration_minutes %> min</span>
            <% end %>
            <% if commitment.position.present? %>
              <span>· #<%= commitment.position %></span>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <p class="mt-2 text-<%= tone %>-200/60">Nessun commitment.</p>
  <% end %>
</div>

<div class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 p-4" data-modal="<%= modal_id %>" role="dialog" aria-modal="true">
  <div class="w-full max-w-lg rounded-2xl border border-[#283039] bg-[#101922] p-6 shadow-2xl">
    <div class="flex items-start justify-between gap-4">
      <div>
        <h3 class="text-lg font-semibold text-white">Nuovo commitment</h3>
        <p class="text-sm text-[#9dabb9] mt-1">
          Eventdate: <%= eventdate.description.presence || "Senza descrizione" %>
        </p>
      </div>
      <button class="text-[#9dabb9] hover:text-white" type="button" data-modal-close="<%= modal_id %>">
        Chiudi
      </button>
    </div>

    <%= form_with model: Commitment.new,
                  url: eventdate_commitments_path(eventdate),
                  class: "mt-4 space-y-3 text-sm" do |form| %>
      <%= form.hidden_field :eventdate_id, value: eventdate.id %>

      <div>
        <%= form.label :role_name, "Ruolo", class: "block text-xs text-[#9dabb9] mb-1" %>
        <%= form.text_field :role_name,
                            class: "w-full rounded-lg border border-[#283039] bg-[#0f172a] px-3 py-2 text-white" %>
      </div>

      <div class="grid gap-3 sm:grid-cols-2">
        <div>
          <%= form.label :commitment_kind, "Tipo", class: "block text-xs text-[#9dabb9] mb-1" %>
          <%= form.select :commitment_kind,
                          Commitment.commitment_kinds.keys.map { |k| [k.humanize, k] },
                          { include_blank: "—" },
                          class: "w-full rounded-lg border border-[#283039] bg-[#0f172a] px-3 py-2 text-white" %>
        </div>
        <div>
          <%= form.label :area, "Area", class: "block text-xs text-[#9dabb9] mb-1" %>
          <%= form.text_field :area,
                              class: "w-full rounded-lg border border-[#283039] bg-[#0f172a] px-3 py-2 text-white" %>
        </div>
      </div>

      <div class="grid gap-3 sm:grid-cols-3">
        <div>
          <%= form.label :role_count, "Numero", class: "block text-xs text-[#9dabb9] mb-1" %>
          <%= form.number_field :role_count,
                                min: 1,
                                value: 1,
                                class: "w-full rounded-lg border border-[#283039] bg-[#0f172a] px-3 py-2 text-white" %>
        </div>
        <div>
          <%= form.label :duration_minutes, "Durata (min)", class: "block text-xs text-[#9dabb9] mb-1" %>
          <%= form.number_field :duration_minutes,
                                min: 0,
                                placeholder: "es. 60",
                                class: "w-full rounded-lg border border-[#283039] bg-[#0f172a] px-3 py-2 text-white" %>
        </div>
        <div>
          <%= form.label :position, "Posizione", class: "block text-xs text-[#9dabb9] mb-1" %>
          <%= form.number_field :position,
                                min: 1,
                                placeholder: "auto",
                                class: "w-full rounded-lg border border-[#283039] bg-[#0f172a] px-3 py-2 text-white" %>
        </div>
      </div>

      <div>
        <%= form.label :notes, "Note", class: "block text-xs text-[#9dabb9] mb-1" %>
        <%= form.text_area :notes,
                           rows: 3,
                           class: "w-full rounded-lg border border-[#283039] bg-[#0f172a] px-3 py-2 text-white" %>
      </div>

      <div class="flex items-center justify-end gap-3 pt-2">
        <button type="button" class="rounded-lg border border-[#283039] px-4 py-2 text-xs font-semibold text-white hover:border-primary" data-modal-close="<%= modal_id %>">
          Annulla
        </button>
        <%= form.submit "Salva",
                        class: "inline-flex items-center rounded-lg bg-primary px-4 py-2 text-xs font-semibold text-white" %>
      </div>
    <% end %>
  </div>
</div>
