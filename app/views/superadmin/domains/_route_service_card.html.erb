<div class="flex flex-col items-center">
  <!-- ðŸš‰ Station Node (Aligns with the background rail) -->
  <div class="relative z-10 flex h-[84px] w-full items-center justify-center">
    <div class="flex h-12 w-12 items-center justify-center rounded-full border-4 border-[#101922] bg-emerald-500 shadow-lg shadow-emerald-900/50">
      <span class="material-symbols-outlined text-white text-[24px]">tram</span>
    </div>
  </div>

  <!-- ðŸ“„ Station Details Card -->
  <div class="w-full rounded-xl border border-emerald-500/30 bg-[#0f172a] p-4 shadow-sm relative top-[-10px]">
    <div class="flex items-center justify-between gap-2 border-b border-emerald-500/10 pb-2 mb-2">
      <div class="flex items-center gap-2 text-emerald-300 text-xs font-semibold uppercase tracking-wide">
        Service
      </div>
      <%= link_to edit_superadmin_service_path(service),
                  data: { turbo_frame: "modal" },
                  aria: { label: "Modifica service" },
                  class: "inline-flex items-center justify-center text-emerald-200 hover:text-white" do %>
        <span class="material-symbols-outlined text-[16px]">edit</span>
      <% end %>
    </div>
    
    <div>
      <p class="text-white font-bold text-lg leading-tight">
        <%= service.name.presence || service.slug %>
      </p>
      <div class="flex items-center gap-1 mt-1 text-xs text-[#9dabb9]">
        <span class="material-symbols-outlined text-[14px]">location_on</span>
        <%= service.taxbranch&.display_label || service.taxbranch&.slug_label || "â€”" %>
      </div>
    </div>
    <div class="mt-4 pt-3 border-t border-[#283039]">
      <!-- ðŸŽ›ï¸ Function Control Panel (Integrated) -->
      <% function_count = service.journeys.to_a.count(&:journey_function?) %>
      <% active_template = service.journey_function_active_template %>
      <% active_function = service.journey_function_active %>
      
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-2">
          <span class="text-[10px] uppercase font-bold tracking-wider text-[#9dabb9]">Funzioni</span>
          <span class="flex h-5 w-5 items-center justify-center rounded-full bg-[#283039] text-[10px] font-bold text-white">
            <%= function_count %>
          </span>
        </div>
        <%= link_to new_journey_path(service_id: service.id, taxbranch_id: service.taxbranch_id, kind: "process", journey_type: "work", journeys_status: "problema"),
                    data: { turbo_frame: "modal" },
                    class: "text-[#9dabb9] hover:text-white transition-colors",
                    title: "Nuova funzione" do %>
          <span class="material-symbols-outlined text-[18px]">add_circle</span>
        <% end %>
      </div>

      <% if active_template.present? || active_function.present? %>
        <div class="space-y-2 mb-3">
          <% if active_template.present? %>
            <% template_params = selected_journeys.merge(service.id.to_s => active_template.id).to_h %>
            <div class="flex items-center justify-between gap-2 rounded border border-blue-500/20 bg-blue-500/5 px-2 py-1.5">
              <div class="flex items-center gap-2 overflow-hidden">
                <%= link_to rails4b_superadmin_domain_path(domain, route: route, selected_journeys: template_params),
                            class: "shrink-0 flex items-center justify-center text-blue-400 hover:text-white" do %>
                  <span class="material-symbols-outlined text-[14px]">content_copy</span>
                <% end %>
                <div class="flex flex-col min-w-0">
                  <span class="text-[9px] uppercase font-semibold text-blue-300/70">Template Attivo</span>
                  <%= link_to active_template.title.presence || active_template.slug,
                              rails4b_superadmin_domain_path(domain, route: route, selected_journeys: template_params),
                              class: "truncate text-[11px] font-medium text-blue-100 hover:text-white hover:underline block" %>
                </div>
              </div>
            </div>
          <% end %>

          <% if active_function.present? %>
            <% active_params = selected_journeys.merge(service.id.to_s => active_function.id).to_h %>
            <div class="flex items-center justify-between gap-2 rounded border border-emerald-500/20 bg-emerald-500/5 px-2 py-1.5">
              <div class="flex items-center gap-2 overflow-hidden">
                <%= link_to rails4b_superadmin_domain_path(domain, route: route, selected_journeys: active_params),
                            class: "shrink-0 flex items-center justify-center text-emerald-400 hover:text-white" do %>
                  <span class="material-symbols-outlined text-[14px]">play_circle</span>
                <% end %>
                <div class="flex flex-col min-w-0">
                  <span class="text-[9px] uppercase font-semibold text-emerald-300/70">In Corso</span>
                  <%= link_to active_function.title.presence || active_function.slug,
                              rails4b_superadmin_domain_path(domain, route: route, selected_journeys: active_params),
                              class: "truncate text-[11px] font-medium text-emerald-100 hover:text-white hover:underline block" %>
                </div>
              </div>
              <%= link_to edit_journey_path(active_function),
                          data: { turbo_frame: "modal" },
                          class: "shrink-0 p-1 text-emerald-500/50 hover:text-emerald-400" do %>
                <span class="material-symbols-outlined text-[14px]">edit</span>
              <% end %>
            </div>
          <% end %>
        </div>
      <% else %>
        <p class="text-[10px] text-[#9dabb9] italic mb-3">Nessuna funzione attiva</p>
      <% end %>

      <!-- Selection Dropdown -->
      <% if function_journeys.any? %>
        <div>
          <%= form_with url: rails4b_superadmin_domain_path(domain), method: :get, local: true, class: "relative" do %>
            <%= hidden_field_tag :route, route if route.present? %>
            <% selected_journeys.each do |service_id, journey_id| %>
              <% next if service_id.to_s == service.id.to_s %>
              <%= hidden_field_tag "selected_journeys[#{service_id}]", journey_id %>
            <% end %>
            
            <div class="relative">
              <span class="pointer-events-none absolute left-2 top-1/2 -translate-y-1/2 material-symbols-outlined text-[14px] text-[#9dabb9]">history</span>
              <%= select_tag "selected_journeys[#{service.id}]",
                             options_for_select(
                               function_journeys.sort_by(&:updated_at).reverse.map { |j| 
                                 label = j.title.presence || j.slug
                                 label += " (Template)" if j.kind == "cycle_template"
                                 [label, j.id] 
                               },
                               selected_journey&.id
                             ),
                             include_blank: "Storico...",
                             class: "w-full appearance-none rounded bg-[#0f172a] border border-[#283039] py-1.5 pl-8 pr-8 text-[11px] text-[#9dabb9] focus:ring-primary focus:text-white cursor-pointer hover:border-[#9dabb9]/50 transition-colors",
                             onchange: "this.form.submit()" %>
               <span class="pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 material-symbols-outlined text-[14px] text-[#9dabb9]">expand_more</span>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>
