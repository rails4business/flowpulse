<% content_for :title, "Service map · #{@service.name.presence || @service.slug}" %>

<style>
  .map-frame {
    background-image: radial-gradient(circle, rgba(255, 255, 255, 0.08) 1px, transparent 1px);
    background-size: 28px 28px;
    position: relative;
    overflow: hidden;
    cursor: grab;
  }
  .map-frame.dragging {
    cursor: grabbing;
  }
  .map-viewport {
    width: 100%;
    height: 520px;
    transform-origin: center;
    transition: transform 0.15s ease;
  }
  .map-label {
    font-size: 12px;
    font-weight: 600;
    fill: #ffffff;
  }
  .map-sub {
    font-size: 10px;
    fill: #9dabb9;
  }
</style>

<div class="space-y-6">
  <div class="rounded-2xl border border-[#283039] bg-[#101922] p-6 shadow-sm">
    <nav class="text-xs text-[#9dabb9] mb-3">
      <%= link_to "Domains", superadmin_domains_path, class: "hover:text-white" %>
      <span class="mx-1">/</span>
      <% if @domain.present? %>
        <%= link_to @domain.title.presence || @domain.host,
                    superadmin_domain_path(@domain),
                    class: "hover:text-white" %>
        <span class="mx-1">/</span>
        <%= link_to "Mapservices",
                    mapservice_superadmin_domain_path(@domain),
                    class: "hover:text-white" %>
        <span class="mx-1">/</span>
        <%= link_to "TestRoute",
                    testroute_superadmin_domain_path(@domain),
                    class: "hover:text-white" %>
        <span class="mx-1">/</span>
      <% end %>
      <%= link_to (@service.name.presence || @service.slug),
                  superadmin_service_path(@service),
                  class: "hover:text-white" %>
      <span class="mx-1">/</span>
      <span class="text-white">Servicemaps</span>
    </nav>
    <div class="flex flex-wrap items-start justify-between gap-4">
      <div>
        <h1 class="text-3xl font-bold text-white">Service map</h1>
        <p class="text-sm text-[#9dabb9] mt-1">
          Mappa dei journey collegati al service <strong><%= @service.name.presence || @service.slug %></strong>.
        </p>
      </div>
      <% if @service.taxbranch.present? %>
        <%= link_to "Apri su Taxbranch",
                    rails4b_superadmin_taxbranch_path(@service.taxbranch, tab: params[:tab].presence || "builders"),
                    class: "inline-flex items-center rounded-lg border border-[#283039] px-3 py-2 text-xs font-semibold text-white hover:border-primary" %>
      <% end %>
    </div>
  </div>

  <% current_tab = params[:tab].presence || "builders" %>
  <div class="rounded-2xl border border-[#283039] bg-[#101922] p-4 shadow-sm">
    <div class="flex flex-wrap gap-3">
      <%= link_to "Builders",
                  rails4b_superadmin_service_path(@service, tab: "builders"),
                  class: class_names(
                    "px-3 py-2 text-sm font-semibold rounded-lg border transition-colors",
                    current_tab == "builders" ? "border-primary text-primary bg-primary/10" : "border-transparent text-[#9dabb9] hover:text-white hover:border-[#3a4652]"
                  ) %>
      <%= link_to "Drivers",
                  rails4b_superadmin_service_path(@service, tab: "drivers"),
                  class: class_names(
                    "px-3 py-2 text-sm font-semibold rounded-lg border transition-colors",
                    current_tab == "drivers" ? "border-primary text-primary bg-primary/10" : "border-transparent text-[#9dabb9] hover:text-white hover:border-[#3a4652]"
                  ) %>
    </div>
  </div>

  <% if current_tab == "builders" %>
    <% builders_tab = params[:builders_tab].presence || "active" %>
    <% journey_to_show = @builders_journey || @fallback_journey %>
    <% if journey_to_show.present? %>
      <div class="rounded-2xl border border-[#283039] bg-[#101922] p-6 shadow-sm">
        <div class="flex items-start justify-between gap-4">
          <div>
            <h2 class="text-lg font-semibold text-white">Builders</h2>
            <p class="text-sm text-[#9dabb9] mt-1">
              Viaggio operativo con fermate = eventdates ordinati per data.
            </p>

          </div>
          <button
            type="button"
            class="inline-flex items-center rounded-lg border border-[#283039] px-3 py-2 text-xs font-semibold text-white hover:border-primary"
            data-builders-journey-open
          >
            Nuovo journey
          </button>
        </div>


        

        <div class="mt-4 flex flex-wrap gap-3">
          <%= link_to "Journey attivo",
                      rails4b_superadmin_service_path(@service, tab: "builders", builders_tab: "active"),
                      class: class_names(
                        "px-3 py-2 text-xs font-semibold rounded-lg border transition-colors",
                        builders_tab == "active" ? "border-primary text-primary bg-primary/10" : "border-transparent text-[#9dabb9] hover:text-white hover:border-[#3a4652]"
                      ) %>
          <%= link_to "Tutti i journey",
                      rails4b_superadmin_service_path(@service, tab: "builders", builders_tab: "all"),
                      class: class_names(
                        "px-3 py-2 text-xs font-semibold rounded-lg border transition-colors",
                        builders_tab == "all" ? "border-primary text-primary bg-primary/10" : "border-transparent text-[#9dabb9] hover:text-white hover:border-[#3a4652]"
                      ) %>
        </div>



 



        <% if builders_tab == "all" %>
          <% if @all_service_journeys.any? %>
            <div class="mt-5 divide-y divide-[#283039] text-sm">
              <% @all_service_journeys.each do |journey| %>
                <div class="py-3 flex flex-wrap items-center justify-between gap-4">
                  <div>
                    <p class="font-medium text-white"><%= journey.title.presence || journey.slug %></p>
                    <p class="text-[#9dabb9] text-xs">
                      <%= journey.kind %> · <%= journey.journey_type %> · Eventi: <%= journey.eventdates.count %>
                    </p>
                  </div>
                  <div class="flex items-center gap-2 text-xs">
                    <%= link_to "Apri journey",
                                journey_path(journey),
                                class: "inline-flex items-center rounded-lg border border-[#283039] px-3 py-1 text-[#9dabb9] hover:text-white" %>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <p class="mt-4 text-sm text-[#9dabb9]">Nessun journey trovato.</p>
          <% end %>
        <% else %>
          <% events = journey_to_show.eventdates.sort_by { |e| e.date_start || e.date_end || e.created_at } %>
          <div class="mt-6 max-w-4xl w-full bg-white border border-slate-200 rounded-2xl shadow-sm p-6">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
              <div>
                <p class="text-xs uppercase tracking-widest text-slate-400">Journey attivo</p>
                <%= link_to (journey_to_show.title.presence || journey_to_show.slug),
                            journey_path(journey_to_show),
                            class: "text-2xl font-black text-slate-900 hover:text-primary" %>
              </div>
              <button
                type="button"
                class="inline-flex items-center rounded-lg border border-slate-300 px-3 py-1.5 text-xs font-semibold text-slate-700 hover:border-slate-400"
                data-active-eventdate-open
              >
                Nuovo evento
              </button>
            </div>
            <div class="relative">
              <div class="absolute left-[20px] top-4 bottom-4 w-1 bg-slate-200 rounded-full"></div>
              <% if events.any? %>
                <div class="space-y-10">
                  <% events.each_with_index do |eventdate, idx| %>
                    <div class="relative pl-14 flex flex-col md:flex-row md:items-start gap-4">
                      <div class="<%= idx.zero? ? "absolute left-0 top-1 size-10 rounded-full bg-white border-4 border-primary flex items-center justify-center z-10" : "absolute left-0 top-1 size-10 rounded-full bg-white border-4 border-slate-200 flex items-center justify-center z-10" %>">
                        <span class="material-symbols-outlined <%= idx.zero? ? "text-primary" : "text-slate-400" %> text-xl">
                          <%= idx.zero? ? "radio_button_checked" : "schedule" %>
                        </span>
                      </div>
                      <div class="flex-1 p-5 rounded-xl border border-slate-100 bg-slate-50/50">
                        <div class="flex justify-between items-start mb-2">
                          <h3 class="text-lg font-bold text-slate-900">
                            <%= eventdate.description.presence || "Senza descrizione" %>
                          </h3>
                          <span class="text-xs font-semibold text-slate-600 bg-white px-2 py-1 rounded border border-slate-100">
                            <%= eventdate.date_start.present? ? l(eventdate.date_start, format: "%d %b %H:%M") : "Data —" %>
                          </span>
                        </div>
                        <p class="text-sm text-slate-500">
                          Ruolo: <%= eventdate.journey_role.presence || "—" %>
                          · Tipo: <%= eventdate.event_type %>
                          · Kind: <%= eventdate.kind_event %>
                        </p>
                        <div class="mt-3 flex flex-wrap items-center gap-4 text-xs text-slate-600 font-semibold">
                          <span>Inizio: <%= eventdate.date_start.present? ? l(eventdate.date_start, format: "%H:%M") : "—" %></span>
                          <span>Fine: <%= eventdate.date_end.present? ? l(eventdate.date_end, format: "%H:%M") : "—" %></span>
                          <span>
                            Durata:
                            <% if eventdate.date_start.present? && eventdate.date_end.present? %>
                              <%= ((eventdate.date_end - eventdate.date_start) / 60).round %> min
                            <% else %>
                              —
                            <% end %>
                          </span>
                          <span>Prezzo: <%= journey_to_show.price_estimate_euro.present? ? number_to_currency(journey_to_show.price_estimate_euro, unit: "€") : "—" %></span>
                          <span>Utente: <%= eventdate.lead&.full_name.presence || "—" %></span>
                        </div>
                        <div class="mt-3">
                          <%= link_to "Apri eventdate", eventdate_path(eventdate), class: "text-xs text-emerald-600 hover:underline" %>
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>
              <% else %>
                <p class="text-sm text-slate-500">Nessun eventdate collegato.</p>
              <% end %>
            </div>
          </div>
        <% end %>
          </div>
        <% else %>
      <div class="rounded-2xl border border-[#283039] bg-[#101922] p-6 shadow-sm">
        <div class="flex items-start justify-between gap-4">
          <div>
            <h2 class="text-lg font-semibold text-white">Builders</h2>
            <p class="text-sm text-[#9dabb9] mt-1">Nessun journey trovato.</p>
          </div>
          <button
            type="button"
            class="inline-flex items-center rounded-lg border border-[#283039] px-3 py-2 text-xs font-semibold text-white hover:border-primary"
            data-builders-journey-open
          >
            Nuovo journey
          </button>
        </div>
      </div>
    <% end %>
  <% else %>
    <div class="rounded-2xl border border-[#283039] bg-[#101922] p-6 shadow-sm">
      <h2 class="text-lg font-semibold text-white">Drivers (cycle_instance)</h2>
      <p class="text-sm text-[#9dabb9] mt-1">
        Journey operativi con eventi, booking e iscrizioni.
      </p>

      <% if @drivers_journeys.any? %>
        <div class="mt-4 divide-y divide-[#283039] text-sm">
          <% @drivers_journeys.each do |journey| %>
            <% booking_count = Booking.where(eventdate_id: journey.eventdates.select(:id)).count %>
            <div class="py-3 flex flex-wrap items-center justify-between gap-4">
              <div>
                <p class="font-medium text-white">
                  <%= journey.title.presence || journey.slug %>
                </p>
                <p class="text-[#9dabb9] text-xs">
                  Eventi: <%= journey.eventdates.count %>
                  · Booking: <%= booking_count %>
                  · Iscritti: <%= journey.enrollments.count %>
                </p>
              </div>
              <div class="flex items-center gap-2 text-xs">
                <%= link_to "Apri journey",
                            journey_path(journey),
                            class: "inline-flex items-center rounded-lg border border-[#283039] px-3 py-1 text-[#9dabb9] hover:text-white" %>
                <% if journey.eventdates.any? %>
                  <%= link_to "Eventdates",
                              eventdates_path(journey_id: journey.id),
                              class: "inline-flex items-center rounded-lg border border-[#283039] px-3 py-1 text-[#9dabb9] hover:text-white" %>
                <% end %>
              </div>
            </div>
          <% end %>
      </div>
    <% else %>
        <p class="mt-3 text-sm text-[#9dabb9]">Nessun journey drivers trovato.</p>
      <% end %>
    </div>
  <% end %>
</div>

<div
  class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 p-4"
  id="active-eventdate-modal"
  role="dialog"
  aria-modal="true"
>
  <div class="w-full max-w-lg rounded-2xl border border-[#283039] bg-[#101922] p-6 shadow-2xl">
    <div class="flex items-start justify-between gap-4">
      <h3 class="text-lg font-semibold text-white">Nuovo evento</h3>
      <button class="text-[#9dabb9] hover:text-white" type="button" data-active-eventdate-close>
        Chiudi
      </button>
    </div>
    <p class="text-sm text-[#9dabb9] mt-1">
      Pianifica un evento per il journey attivo.
    </p>

    <% if journey_to_show.present? %>
      <%= form_with model: Eventdate.new, url: eventdates_path, class: "mt-4 space-y-3 text-sm" do |form| %>
        <%= form.hidden_field :journey_id, value: journey_to_show.id %>
        <%= form.hidden_field :lead_id, value: Current.user&.lead&.id %>
        <div>
          <%= form.label :description, "Descrizione", class: "block text-xs text-[#9dabb9] mb-1" %>
          <%= form.text_area :description, rows: 3, required: true, class: "w-full rounded-lg border border-[#283039] bg-[#0f172a] px-3 py-2 text-white" %>
        </div>
        <div class="grid gap-3 sm:grid-cols-2">
          <div>
            <%= form.label :date_start, "Inizio", class: "block text-xs text-[#9dabb9] mb-1" %>
            <%= form.datetime_local_field :date_start, class: "w-full rounded-lg border border-[#283039] bg-[#0f172a] px-3 py-2 text-white" %>
          </div>
          <div>
            <%= form.label :date_end, "Fine", class: "block text-xs text-[#9dabb9] mb-1" %>
            <%= form.datetime_local_field :date_end, class: "w-full rounded-lg border border-[#283039] bg-[#0f172a] px-3 py-2 text-white" %>
          </div>
        </div>
        <div class="grid gap-3 sm:grid-cols-2">
          <div>
            <%= form.label :journey_role, "Ruolo", class: "block text-xs text-[#9dabb9] mb-1" %>
            <% roles = Array(journey_to_show.journey_roles) %>
            <%= form.select :journey_role,
                  options_for_select(roles),
                  { include_blank: "—" },
                  class: "w-full rounded-lg border border-[#283039] bg-[#0f172a] px-3 py-2 text-white",
                  disabled: roles.empty? %>
          </div>
          <div>
            <%= form.label :event_type, "Tipo", class: "block text-xs text-[#9dabb9] mb-1" %>
            <%= form.select :event_type,
                  Eventdate.event_types.keys.map { |t| [t.humanize, t] },
                  {},
                  class: "w-full rounded-lg border border-[#283039] bg-[#0f172a] px-3 py-2 text-white" %>
          </div>
        </div>
        <div>
          <%= form.label :kind_event, "Kind", class: "block text-xs text-[#9dabb9] mb-1" %>
          <% kind_labels = { "session" => "Sessione", "meeting" => "Riunione", "online_call" => "Chiamata online", "recording" => "Registrazione" } %>
          <%= form.select :kind_event,
                Eventdate.kind_events.keys.map { |t| [kind_labels.fetch(t, t.humanize), t] },
                { include_blank: "—" },
                class: "w-full rounded-lg border border-[#283039] bg-[#0f172a] px-3 py-2 text-white" %>
        </div>
        <div class="flex items-center justify-end gap-3 pt-2">
          <button
            type="button"
            class="rounded-lg border border-[#283039] px-4 py-2 text-xs font-semibold text-white hover:border-primary"
            data-active-eventdate-close
          >
            Annulla
          </button>
          <%= form.submit "Crea evento", class: "inline-flex items-center rounded-lg bg-primary px-4 py-2 text-xs font-semibold text-white" %>
        </div>
      <% end %>
    <% else %>
      <p class="mt-4 text-sm text-[#9dabb9]">
        Nessun journey attivo: crea un journey per poter aggiungere eventi.
      </p>
    <% end %>
  </div>
</div>

<script>
  (() => {
    const modal = document.getElementById("active-eventdate-modal");
    const openBtn = document.querySelector("[data-active-eventdate-open]");
    const closeBtns = modal?.querySelectorAll("[data-active-eventdate-close]") || [];
    if (!modal || !openBtn) return;

    const openModal = () => {
      modal.classList.remove("hidden");
      modal.classList.add("flex");
    };
    const closeModal = () => {
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    };

    openBtn.addEventListener("click", openModal);
    closeBtns.forEach((btn) => btn.addEventListener("click", closeModal));
  })();
</script>

<div
  class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 p-4"
  id="builders-journey-modal"
  role="dialog"
  aria-modal="true"
>
  <div class="w-full max-w-lg rounded-2xl border border-[#283039] bg-[#101922] p-6 shadow-2xl">
    <div class="flex items-start justify-between gap-4">
      <h3 class="text-lg font-semibold text-white">Nuovo journey (builders)</h3>
      <button class="text-[#9dabb9] hover:text-white" type="button" data-builders-journey-close>
        Chiudi
      </button>
    </div>
    <p class="text-sm text-[#9dabb9] mt-1">
      Crea un journey cycle_template collegato al service.
    </p>

    <%= form_with model: Journey.new, url: journeys_path, class: "mt-4 space-y-3 text-sm" do |form| %>
      <%= form.hidden_field :service_id, value: @service.id %>
      <%= form.hidden_field :kind, value: "cycle_template" %>
      <%= form.hidden_field :lead_id, value: Current.user&.lead&.id %>

      <div>
        <%= form.label :title, "Titolo", class: "block text-xs text-[#9dabb9] mb-1" %>
        <%= form.text_field :title,
              value: "Percorso #{@service.name.presence || @service.slug}",
              class: "w-full rounded-lg border border-[#283039] bg-[#0f172a] px-3 py-2 text-white",
              required: true %>
      </div>

      <div>
        <%= form.label :notes, "Descrizione/Note", class: "block text-xs text-[#9dabb9] mb-1" %>
        <%= form.text_area :notes, rows: 3, class: "w-full rounded-lg border border-[#283039] bg-[#0f172a] px-3 py-2 text-white", required: true %>
      </div>

      <div class="grid gap-3 sm:grid-cols-2">
        <div>
          <%= form.label :journey_type, "Categoria", class: "block text-xs text-[#9dabb9] mb-1" %>
          <%= form.select :journey_type,
                Journey.journey_types.keys.map { |t| [t.humanize, t] },
                { include_blank: "Seleziona" },
                class: "w-full rounded-lg border border-[#283039] bg-[#0f172a] px-3 py-2 text-white" %>
        </div>
        <div>
          <%= form.label :kind, "Tipo", class: "block text-xs text-[#9dabb9] mb-1" %>
          <%= form.select :kind,
                Journey.kinds.keys.map { |k| [k.humanize, k] },
                { include_blank: "Seleziona" },
                class: "w-full rounded-lg border border-[#283039] bg-[#0f172a] px-3 py-2 text-white" %>
        </div>
      </div>
      <div>
        <%= form.label :journeys_status, "Fase", class: "block text-xs text-[#9dabb9] mb-1" %>
        <%= form.select :journeys_status,
              options_for_select(Journey.journeys_statuses.keys.map { |p| [p.humanize, p] }, "problema"),
              {},
              class: "w-full rounded-lg border border-[#283039] bg-[#0f172a] px-3 py-2 text-white" %>
      </div>
      <div class="grid gap-3 sm:grid-cols-2">
        <div>
          <%= form.label :start_at, "Start at", class: "block text-xs text-[#9dabb9] mb-1" %>
          <%= form.datetime_local_field :start_at, class: "w-full rounded-lg border border-[#283039] bg-[#0f172a] px-3 py-2 text-white" %>
        </div>
        <div>
          <%= form.label :end_at, "End at", class: "block text-xs text-[#9dabb9] mb-1" %>
          <%= form.datetime_local_field :end_at, class: "w-full rounded-lg border border-[#283039] bg-[#0f172a] px-3 py-2 text-white" %>
        </div>
      </div>

      <div class="grid gap-3 sm:grid-cols-2">
        <div>
          <%= form.label :taxbranch_id, "Stazione iniziale", class: "block text-xs text-[#9dabb9] mb-1" %>
          <%= form.number_field :taxbranch_id, value: @service.taxbranch_id, class: "w-full rounded-lg border border-[#283039] bg-[#0f172a] px-3 py-2 text-white" %>
        </div>
        <div>
          <%= form.label :end_taxbranch_id, "Stazione finale", class: "block text-xs text-[#9dabb9] mb-1" %>
          <%= form.number_field :end_taxbranch_id, class: "w-full rounded-lg border border-[#283039] bg-[#0f172a] px-3 py-2 text-white" %>
        </div>
      </div>

      <div>
        <%= form.label :journey_roles_text, "Ruoli (uno per riga)", class: "block text-xs text-[#9dabb9] mb-1" %>
        <%= form.text_area :journey_roles_text, rows: 3, class: "w-full rounded-lg border border-[#283039] bg-[#0f172a] px-3 py-2 text-white" %>
      </div>

      <div class="flex items-center justify-end gap-3 pt-2">
        <button
          type="button"
          class="rounded-lg border border-[#283039] px-4 py-2 text-xs font-semibold text-white hover:border-primary"
          data-builders-journey-close
        >
          Annulla
        </button>
        <%= form.submit "Crea journey",
              class: "inline-flex items-center rounded-lg bg-primary px-4 py-2 text-xs font-semibold text-white" %>
      </div>
    <% end %>
  </div>
</div>

<script>
  (() => {
    const modal = document.getElementById("builders-journey-modal");
    const openers = document.querySelectorAll("[data-builders-journey-open]");
    const closers = modal?.querySelectorAll("[data-builders-journey-close]") || [];
    if (!modal || openers.length === 0) return;

    const openModal = () => {
      modal.classList.remove("hidden");
      modal.classList.add("flex");
    };
    const closeModal = () => {
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    };

    openers.forEach((btn) => btn.addEventListener("click", openModal));
    closers.forEach((btn) => btn.addEventListener("click", closeModal));
  })();
</script>

<script>
  (() => {
    const viewport = document.getElementById("map-viewport");
    const frame = viewport?.closest(".map-frame");
    if (!viewport || !frame) return;
    let scale = 1;
    let offsetX = 0;
    let offsetY = 0;
    let dragging = false;
    let startX = 0;
    let startY = 0;
    const clamp = (value, min, max) => Math.min(Math.max(value, min), max);

    function applyTransform() {
      viewport.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale.toFixed(2)})`;
    }

    document.querySelectorAll("[data-zoom]").forEach((btn) => {
      btn.addEventListener("pointerdown", (event) => {
        event.stopPropagation();
      });
      btn.addEventListener("click", () => {
        const action = btn.getAttribute("data-zoom");
        if (action === "in") scale = clamp(scale + 0.1, 0.6, 2);
        if (action === "out") scale = clamp(scale - 0.1, 0.6, 2);
        if (action === "reset") {
          scale = 1;
          offsetX = 0;
          offsetY = 0;
        }
        applyTransform();
      });
    });

    frame.addEventListener("pointerdown", (event) => {
      if (event.button !== 0) return;
      if (event.target.closest("[data-zoom]")) return;
      if (event.target.closest("a")) return;
      dragging = true;
      startX = event.clientX - offsetX;
      startY = event.clientY - offsetY;
      frame.classList.add("dragging");
      frame.setPointerCapture(event.pointerId);
    });

    frame.addEventListener("pointermove", (event) => {
      if (!dragging) return;
      offsetX = event.clientX - startX;
      offsetY = event.clientY - startY;
      applyTransform();
    });

    frame.addEventListener("pointerup", () => {
      dragging = false;
      frame.classList.remove("dragging");
    });

    frame.addEventListener("pointercancel", () => {
      dragging = false;
      frame.classList.remove("dragging");
    });

    applyTransform();
  })();
</script>
