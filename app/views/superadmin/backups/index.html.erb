<section class="mx-auto w-full max-w-5xl px-4 py-8 md:px-8">
  <% if flash.now[:notice].present? %>
    <div class="mb-6 rounded-xl border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-800">
      <%= flash.now[:notice] %>
    </div>
  <% end %>

  <% if flash.now[:alert].present? %>
    <div class="mb-6 rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-800">
      <%= flash.now[:alert] %>
    </div>
  <% end %>

  <div class="rounded-2xl border border-sky-100 bg-white p-6 shadow-sm md:p-8">
    <h1 class="text-2xl font-semibold text-slate-900 md:text-3xl">Backup database con Hatchbox</h1>
    <p class="mt-3 text-sm leading-relaxed text-slate-600 md:text-base">
      Questa pagina e una guida operativa: il backup effettivo conviene farlo da Hatchbox, che gestisce snapshot cifrate e restore controllato.
    </p>
  </div>

  <article class="mt-6 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
    <div class="flex flex-wrap items-start justify-between gap-3">
      <div>
        <h2 class="text-lg font-semibold text-slate-900">Import guidato dump locale</h2>
        <p class="mt-1 text-sm text-slate-600">
          Carica `.sql`, `.sql.gz`, `.dump` o `.tar`, scegli una strategia e ottieni il piano comandi.
        </p>
      </div>
      <% unless @development_env %>
        <span class="rounded-full border border-amber-300 bg-amber-50 px-3 py-1 text-xs font-semibold text-amber-800">
          Modalita consigliata: solo development
        </span>
      <% end %>
    </div>

    <%= form_with url: analyze_superadmin_backups_path, method: :post, scope: nil, local: true, data: { turbo: false }, multipart: true, class: "mt-5 grid gap-4 md:grid-cols-3 md:items-end" do |f| %>
      <div class="md:col-span-2">
        <label class="mb-1 block text-sm font-medium text-slate-700">File dump</label>
        <%= f.file_field :dump_file, accept: ".sql,.gz,.sql.gz,.dump,.tar", class: "block w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700" %>
      </div>

      <div>
        <label class="mb-1 block text-sm font-medium text-slate-700">Strategia</label>
        <%= select_tag :strategy,
              options_for_select(@strategies, @selected_strategy),
              class: "block w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700" %>
      </div>

      <div class="md:col-span-3">
        <%= f.submit "Analizza e prepara piano", class: "inline-flex items-center rounded-lg bg-sky-600 px-4 py-2 text-sm font-semibold text-white hover:bg-sky-700" %>
      </div>
    <% end %>

    <% if @analysis.present? %>
      <div class="mt-6 grid gap-4 md:grid-cols-2">
        <div class="rounded-xl border border-slate-200 bg-slate-50 p-4">
          <h3 class="text-sm font-semibold text-slate-900">Analisi dump</h3>
          <ul class="mt-3 space-y-1 text-sm text-slate-700">
            <li><strong>File:</strong> <%= @analysis[:filename] %></li>
            <li><strong>Dimensione:</strong> <%= @analysis[:size_human] %></li>
            <li><strong>Formato:</strong> <%= @analysis[:gzipped] ? "gzip (.sql.gz)" : "SQL plain" %></li>
            <li><strong>Formato rilevato:</strong> <%= @analysis[:detected_format] %></li>
            <li><strong>Dump custom (PGDMP):</strong> <%= @analysis[:custom_dump_format] ? "Si" : "No" %></li>
            <li><strong>Firma pg_dump:</strong> <%= @analysis[:has_pg_dump_signature] ? "Si" : "Non rilevata" %></li>
            <li><strong>Tabelle trovate:</strong> <%= @analysis[:tables_count] %></li>
          </ul>
        </div>

        <div class="rounded-xl border border-slate-200 bg-slate-50 p-4">
          <h3 class="text-sm font-semibold text-slate-900">Tabelle individuate</h3>
          <p class="mt-2 text-xs text-slate-500">Anteprima prime 16 tabelle</p>
          <div class="mt-2 flex flex-wrap gap-2">
            <% @analysis[:tables].first(16).each do |table_name| %>
              <span class="rounded-full border border-slate-300 bg-white px-2 py-1 text-xs text-slate-700"><%= table_name %></span>
            <% end %>
          </div>
        </div>
      </div>

      <div class="mt-4 rounded-xl border border-slate-200 bg-slate-900 p-4 text-sm text-slate-100">
        <h3 class="mb-2 text-sm font-semibold text-white">Piano comandi</h3>
        <pre class="overflow-x-auto whitespace-pre-wrap"><code><%= @commands.join("\n") %></code></pre>
      </div>

      <% if @analysis[:custom_dump_format] %>
        <div class="mt-4 rounded-xl border border-amber-200 bg-amber-50 p-4 text-sm text-amber-900">
          Il file sembra un dump PostgreSQL custom (`PGDMP`). Per analisi completa usa `pg_restore -l file.dump`.
        </div>
      <% end %>
    <% end %>
  </article>

  <div class="mt-6 grid gap-6 md:grid-cols-2">
    <article class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
      <h2 class="text-lg font-semibold text-slate-900">Procedura backup (Hatchbox)</h2>
      <ol class="mt-4 list-decimal space-y-2 pl-5 text-sm leading-relaxed text-slate-700">
        <li>Apri Hatchbox e seleziona il tuo ambiente (`production` o `staging`).</li>
        <li>Vai su <strong>Databases</strong> e scegli il database PostgreSQL dell'app.</li>
        <li>Clicca <strong>Create Backup</strong> (o <strong>Run Backup Now</strong>).</li>
        <li>Attendi stato <strong>Completed</strong> e verifica data/ora del dump.</li>
        <li>Se serve, scarica il file di backup solo in ambiente sicuro.</li>
      </ol>
    </article>

    <article class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
      <h2 class="text-lg font-semibold text-slate-900">Restore di test (consigliato)</h2>
      <ol class="mt-4 list-decimal space-y-2 pl-5 text-sm leading-relaxed text-slate-700">
        <li>Ripristina prima su <strong>staging</strong>, non direttamente in produzione.</li>
        <li>Confronta numero record principali (utenti, post, iscrizioni, eventi).</li>
        <li>Verifica login e pagine critiche dopo il restore.</li>
        <li>Solo dopo test positivo, considera restore su produzione.</li>
      </ol>
    </article>
  </div>

  <article class="mt-6 rounded-2xl border border-amber-200 bg-amber-50 p-6 shadow-sm">
    <h2 class="text-lg font-semibold text-amber-900">Regole di sicurezza minime</h2>
    <ul class="mt-4 list-disc space-y-2 pl-5 text-sm leading-relaxed text-amber-900">
      <li>Accesso Hatchbox con 2FA attivo.</li>
      <li>Permessi separati: solo superadmin per backup/restore.</li>
      <li>Mai inviare dump database su chat/email non protette.</li>
      <li>Conserva i backup con retention periodica (giornaliero + settimanale).</li>
      <li>Documenta ogni restore con data, motivo e risultato del test.</li>
    </ul>
  </article>
</section>
