<%# app/views/superadmin/leads/_row.html.erb %>
<% u = lead.user || User.find_by(email_address: lead.email) %>

<%
  status_str =
    if u&.respond_to?(:state_registration)
      u.state_registration
    else
      (u.nil? ? "unregistered" : "unknown")
    end

  badge_class =
    case status_str
    when "approved"     then "bg-emerald-50 text-emerald-700 ring-1 ring-emerald-600/20"
    when "pending"      then "bg-amber-50 text-amber-700 ring-1 ring-amber-600/20"
    when "rejected"     then "bg-red-50 text-red-700 ring-1 ring-red-600/20"
    when "suspended"    then "bg-slate-100 text-slate-700 ring-1 ring-slate-600/20"
    when "unregistered" then "bg-slate-50 text-slate-600 ring-1 ring-slate-500/20"
    else                     "bg-slate-50 text-slate-600 ring-1 ring-slate-500/20"
    end
%>

<tr class="hover:bg-slate-50/50 transition-colors">
  <!-- Lead Info -->
  <td class="px-4 py-3">
    <div class="flex flex-col">
      <span class="font-semibold text-slate-900"><%= lead.username.presence || "—" %></span>
      <div class="flex items-center gap-2 mt-1">
        <span class="text-xs text-slate-500">Lead #<%= lead.id %></span>
        <% if u %>
          <span class="text-xs text-slate-400">•</span>
          <span class="text-xs text-slate-500">User #<%= u.id %></span>
        <% end %>
      </div>
    </div>
  </td>

  <!-- Email -->
  <td class="px-4 py-3">
    <%= mail_to lead.email, lead.email, class: "text-blue-600 hover:text-blue-700 font-medium" %>
  </td>

  <!-- Created At -->
  <td class="px-4 py-3 text-slate-600">
    <div class="flex flex-col">
      <span class="text-sm"><%= l(lead.created_at, format: "%d %b %Y") rescue "—" %></span>
      <span class="text-xs text-slate-400"><%= l(lead.created_at, format: "%H:%M") rescue "" %></span>
    </div>
  </td>

  <!-- Status -->
  <td class="px-4 py-3">
    <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium <%= badge_class %>">
      <%= status_str.humanize %>
    </span>
  </td>

  <!-- Referral -->
  <td class="px-4 py-3">
    <% referral_link =
         if u&.respond_to?(:referral_url)
           u.referral_url(host: (Current.domain&.host || "http://localhost:3000"))
         end %>

    <% if u&.approved? && referral_link.present? %>
      <div class="flex items-center gap-2 max-w-xs">
        <input type="text" readonly value="<%= referral_link %>"
               class="flex-1 rounded-md border-slate-200 px-2 py-1 text-xs bg-slate-50 text-slate-600 font-mono">
        <button data-action="click->clipboard#copy"
                data-clipboard-text-value="<%= referral_link %>"
                class="text-xs rounded-md border border-slate-200 px-2 py-1 hover:bg-slate-50 text-slate-600 font-medium transition-colors">
          Copia
        </button>
      </div>
    <% else %>
      <span class="text-slate-400 text-sm">—</span>
    <% end %>
  </td>

  <!-- Actions -->
  <td class="px-4 py-3">
    <div class="flex items-center justify-end gap-2">
      <% if (Current.user&.superadmin? || Current.user&.tutor_or_manager?) && (u.nil? || u.pending?) %>
        <%= button_to approve_superadmin_lead_path(lead),
              method: :post,
              form: { data: { turbo_confirm: "Confermi approvazione?" } },
              class: "inline-flex items-center rounded-lg border border-emerald-200 bg-emerald-50 px-3 py-1.5 text-xs font-semibold text-emerald-700 hover:bg-emerald-100 transition-colors" do %>
          <span class="material-symbols-outlined text-[16px] mr-1">check_circle</span>
          Approva
        <% end %>
      <% end %>

      <%= button_to superadmin_lead_path(lead),
            method: :delete,
            form: { data: { turbo_confirm: "Rimuovere questo lead?" } },
            class: "inline-flex items-center rounded-lg border border-red-200 bg-red-50 px-3 py-1.5 text-xs font-semibold text-red-700 hover:bg-red-100 transition-colors" do %>
        <span class="material-symbols-outlined text-[16px] mr-1">delete</span>
        Rimuovi
      <% end %>
    </div>
  </td>
</tr>
