<!-- app/views/superadmin/taxbranches/show.html.erb -->
<% content_for :nav do %>
  <%= render "shared/taxbranch_nav", taxbranch: @taxbranch %>
<% end %>

<!-- Breadcrumb + Title + Actions -->
<div class="mb-4 flex items-start justify-between gap-3 mt-8">
  <div class="flex-1 min-w-0">
    <nav class="text-sm text-slate-600">
      <% if Current.domain&.taxbranch %>
        <%= taxbranch_breadcrumb(
              @taxbranch,
              starting_node: Current.domain&.taxbranch
            ) %>
      <% else %>
        <%= taxbranch_breadcrumb(@taxbranch_node) %>
      <% end %>
    </nav>

    <div class="flex items-center gap-2 text-xs text-slate-600 mt-1">
      <%= link_to "⬅️ Torna su",
                  (@taxbranch.parent ? superadmin_taxbranch_path(@taxbranch.parent) : superadmin_taxbranches_path),
                  class: "text-gray-600 hover:underline" %>
      <span class="text-slate-400">·</span>
      <span>User: <%= Current.user&.id %></span>
      <span class="text-slate-400">·</span>
      <span>Lead: <%= Current.user&.lead&.id %></span>
    </div>
  </div>
  <div class="flex shrink-0 items-center gap-2">
    <%= link_to "Modifica taxbranch",
                edit_superadmin_taxbranch_path(@taxbranch),
                class: "inline-flex items-center rounded-md bg-slate-900 px-3 py-2 text-sm font-semibold text-white hover:bg-slate-800" %>
  </div>
</div>

<!-- RENDER DEL NODO (già presente) -->
<% expanded_ids = [@taxbranch.id] %>

<div id="form-post">
  <%= render "node", node: @taxbranch, expanded_ids: expanded_ids %>
</div>


<br>

<!-- FORM RAPIDO PER MODIFICARE STATO / VISIBILITÀ / PUBLISHED_AT -->
<div class="mb-6 rounded-xl border border-slate-200 bg-white p-4 shadow-sm" id="tax-edit-form">
  <div class="mb-3 block items-center justify-between gap-3">
    <!-- PANNELLO STATO / VISIBILITÀ / PUBLICATION -->
  <div class="mb-6 grid gap-4 md:grid-cols-4">
    <div class="rounded-xl border border-slate-200 bg-white p-4 shadow-sm">
      <p class="text-xs font-semibold uppercase tracking-wide text-slate-500 flex items-center gap-1">
       
        Stato editoriale:
  
        <%# usa lo stesso stile dei badge che usi per i post, ma qui sul taxbranch %>
        <% case @taxbranch.status %>
        <% when "published" %>
          <span class="inline-flex items-center gap-1 rounded-full bg-emerald-100 px-2 py-0.5 text-xs font-medium text-emerald-800">
            <span class="material-symbols-outlined text-[12px]">check_circle</span>
            Pubblicato
          </span>
        <% when "draft" %>
          <span class="inline-flex items-center gap-1 rounded-full bg-amber-100 px-2 py-0.5 text-xs font-medium text-amber-800">
            <span class="material-symbols-outlined text-[12px]">edit</span>
            Bozza
          </span>
        <% when "in_review" %>
          <span class="inline-flex items-center gap-1 rounded-full bg-sky-100 px-2 py-0.5 text-xs font-medium text-sky-700">
            <span class="material-symbols-outlined text-[12px]">rate_review</span>
            In revisione
          </span>
        <% when "archived" %>
          <span class="inline-flex items-center gap-1 rounded-full bg-slate-200 px-2 py-0.5 text-xs font-medium text-slate-700">
            <span class="material-symbols-outlined text-[12px]">inventory_2</span>
            Archivio
          </span>
        <% else %>
          <span class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-2 py-0.5 text-xs font-medium text-slate-600">
            <span class="material-symbols-outlined text-[12px]">info</span>
            <%= @taxbranch.status.to_s.titleize %>
          </span>
        <% end %>
      </p>
      <p class="mt-2 text-xs text-slate-500">
        Status e visibilità ora si gestiscono a livello di Taxbranch e si riflettono su Post/Journey/Service collegati.
      </p>
    </div>

    <div class="rounded-xl border border-slate-200 bg-white p-4 shadow-sm">
      <p class="text-xs font-semibold uppercase tracking-wide text-slate-500 flex items-center gap-1">
        
        Visibilità:
    
        <% human_visibility =
            case @taxbranch.visibility
            when "private_node"      then "Privato"
            when "shared_node"       then "Condiviso"
            when "participants_only" then "Solo partecipanti"
            when "public_node"       then "Pubblico"
            else @taxbranch.visibility.to_s.titleize
            end %>

        <% visibility_icon =
             case @taxbranch.visibility
             when "private_node"      then "lock"
             when "shared_node"       then "groups"
             when "participants_only" then "badge"
             when "public_node"       then "public"
             else "info"
             end %>

        <% if @taxbranch.public_node? && @taxbranch.post&.persisted? %>
          <%= link_to post_path(@taxbranch.post),
                      class: "inline-flex items-center gap-1 rounded-full bg-slate-100 px-2 py-0.5 text-xs font-medium text-slate-700 hover:bg-slate-200" do %>
            <span class="material-symbols-outlined text-[12px]"><%= visibility_icon %></span>
            <%= human_visibility %>
          <% end %>
        <% else %>
          <span class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-2 py-0.5 text-xs font-medium text-slate-700">
            <span class="material-symbols-outlined text-[12px]"><%= visibility_icon %></span>
            <%= human_visibility %>
          </span>
        <% end %>
      </p>
      <p class="mt-2 text-xs text-slate-500">
        Controlla chi può vedere i contenuti di questo ramo (post, percorsi, ecc.).
      </p>
    </div>

    <div class="rounded-xl border border-slate-200 bg-white p-4 shadow-sm">
      <p class="text-xs font-semibold uppercase tracking-wide text-slate-500 flex items-center gap-1">
       
        Fase:
        <% if @taxbranch.phase.present? %>
          <span class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-2 py-0.5 text-xs font-medium text-slate-700">
            <span class="material-symbols-outlined text-[12px]">trip_origin</span>
            <%= @taxbranch.phase.humanize %>
          </span>
        <% else %>
          <span class="text-slate-400">Non impostata</span>
        <% end %>
      </p>
      <p class="mt-2 text-xs text-slate-500">
        Fase di progetto usata per abilitare i servizi collegati.
      </p>
    </div>

    <div class="rounded-xl border border-slate-200 bg-white p-4 shadow-sm">
      <p class="text-xs font-semibold uppercase tracking-wide text-slate-500 flex items-center gap-1">
      Pubblicato:
        <% if @taxbranch.published_at.present? %>
          <%= @taxbranch.published_at.strftime("%d/%m/%Y %H:%M") %>
        <% else %>
          <span class="text-slate-400">Non impostata</span>
        <% end %>
      </p>
      <p class="mt-2 text-xs text-slate-500">
        Usata per ordinare i contenuti nel blog/roadmap (es. Post.published_recent).
      </p>
    </div>
  </div>
    <% if params[:edit_tax] == "true" %>
      <%= link_to "Chiudi modifica",
                  superadmin_taxbranch_path(@taxbranch, anchor: "tax-edit-form"),
                  class: "inline-flex items-center rounded-md border border-slate-300 px-2.5 py-1 text-xs font-semibold text-slate-700 hover:bg-slate-50" %>
    <% else %>
      <%= link_to "Modifica",
                  superadmin_taxbranch_path(@taxbranch, edit_tax: true, anchor: "tax-edit-form"),
                  class: "inline-flex items-center rounded-md bg-slate-900 px-2.5 py-1 text-xs font-semibold text-white hover:bg-slate-800" %>
    <% end %>
  </div>

  <% if params[:edit_tax] == "true" %>
    <%= form_with model: @taxbranch,
                  url: superadmin_taxbranch_path(@taxbranch),
                  method: :patch,
                  local: true,
                  class: "grid gap-4 md:grid-cols-5 items-end" do |f| %>

    <div>
      <%= f.label :status, "Stato", class: "block text-xs font-medium text-slate-600" %>
      <%= f.select :status,
                   Taxbranch.statuses.keys.map { |s| [s.humanize, s] },
                   {},
                   class: "mt-1 w-full rounded-lg border border-slate-300 px-2 py-1.5 text-sm" %>
    </div>

    <div>
      <%= f.label :visibility, "Visibilità", class: "block text-xs font-medium text-slate-600" %>
      <%= f.select :visibility,
                   [
                     ["Privato",          :private_node],
                     ["Condiviso",        :shared_node],
                     ["Solo partecipanti",:participants_only],
                     ["Pubblico",         :public_node]
                   ],
                   { selected: @taxbranch.visibility },
                   class: "mt-1 w-full rounded-lg border border-slate-300 px-2 py-1.5 text-sm" %>
    </div>

    <div>
      <%= f.label :phase, "Fase", class: "block text-xs font-medium text-slate-600" %>
      <%= f.select :phase,
                   Taxbranch.phases.keys.map { |p| [p.humanize, p] },
                   { include_blank: "—", selected: @taxbranch.phase },
                   class: "mt-1 w-full rounded-lg border border-slate-300 px-2 py-1.5 text-sm" %>
    </div>

    <div>
      <%= f.label :published_at, "Data pubblicazione", class: "block text-xs font-medium text-slate-600" %>
      <%= f.datetime_local_field :published_at,
                                 value: @taxbranch.published_at&.strftime("%Y-%m-%dT%H:%M"),
                                 class: "mt-1 w-full rounded-lg border border-slate-300 px-2 py-1.5 text-sm" %>
    </div>

    <div class="md:text-right">
      <%= f.submit "Aggiorna",
                   class: "inline-flex items-center rounded-lg bg-emerald-600 px-3 py-2 text-sm font-semibold text-white hover:bg-emerald-700" %>
    </div>
    <% end %>
  <% end %>
</div>

<!-- DETTAGLI TAXBRANCH -->
<div class="mb-6 rounded-xl border border-slate-200 bg-white p-4 shadow-sm">
  <h3 class="text-sm font-semibold text-slate-800 mb-3">Dettagli</h3>
  <div class="grid gap-4 md:grid-cols-2">
    <div class="text-sm">
      <p class="text-xs uppercase tracking-wide text-slate-500">Slug</p>
      <p class="mt-1 text-slate-800"><%= @taxbranch.slug %></p>
      <p class="text-xs text-slate-500 mt-1">
        Categoria: <strong><%= @taxbranch.slug_category %></strong> ·
        Etichetta: <strong><%= @taxbranch.slug_label %></strong>
      </p>
    </div>

    <div class="text-sm">
      <p class="text-xs uppercase tracking-wide text-slate-500">Parent</p>
      <% if @taxbranch.parent.present? %>
        <p class="mt-1 text-slate-800">
          <%= link_to @taxbranch.parent.display_label,
                      superadmin_taxbranch_path(@taxbranch.parent),
                      class: "text-blue-600 hover:underline" %>
        </p>
      <% else %>
        <p class="mt-1 text-slate-500">Nessun parent (root)</p>
      <% end %>
      <p class="text-xs text-slate-500 mt-1">
        Ancestry: <%= @taxbranch.ancestry.presence || "—" %>
      </p>
    </div>

    <div class="text-sm">
      <p class="text-xs uppercase tracking-wide text-slate-500">Lead</p>
      <p class="mt-1 text-slate-800">
        ID: <%= @taxbranch.lead_id || "—" %>
      </p>
    </div>

    <div class="text-sm">
      <p class="text-xs uppercase tracking-wide text-slate-500">Posizione</p>
      <p class="mt-1 text-slate-800">Position: <%= @taxbranch.position || "—" %></p>
      <p class="text-xs text-slate-500 mt-1">
        Home nav: <%= @taxbranch.home_nav? ? "Sì" : "No" %>
      </p>
    </div>

    <div class="text-sm">
      <p class="text-xs uppercase tracking-wide text-slate-500">Date</p>
      <p class="mt-1 text-slate-800">
        Pubblicazione: <%= @taxbranch.published_at ? l(@taxbranch.published_at, format: :short) : "—" %>
      </p>
      <p class="text-xs text-slate-500 mt-1">
        Programmata: <%= @taxbranch.scheduled_at ? l(@taxbranch.scheduled_at, format: :short) : "—" %>
      </p>
    </div>

    <div class="text-sm">
      <p class="text-xs uppercase tracking-wide text-slate-500">GeneraImpresa</p>
      <% if @taxbranch.generaimpresa_md.present? %>
        <p class="mt-1 text-slate-800">Presente</p>
        <%= link_to "Apri tab",
                    generaimpresa_superadmin_taxbranch_path(@taxbranch),
                    class: "text-xs text-blue-600 hover:underline" %>
      <% else %>
        <p class="mt-1 text-slate-500">Non presente</p>
      <% end %>
    </div>

    <div class="text-sm md:col-span-2">
      <p class="text-xs uppercase tracking-wide text-slate-500">Note interne</p>
      <p class="mt-1 text-slate-800 whitespace-pre-line"><%= @taxbranch.notes.presence || "—" %></p>
    </div>
  </div>
</div>



  <% if (diagram_code = @taxbranch.post&.mermaid).present? %>
    <div class="mb-6">
      <%= render "shared/mermaid_diagram",
                mermaid: diagram_code,
                badge: "Genera Impresa",
                title: "Diagramma della campagna",
                subtitle: @taxbranch.display_label,
                hint: "Aggiorna il codice dal post collegato al ramo." %>
    </div>
  <% end %>

  <div class="mb-6 rounded-xl border border-slate-200 bg-white p-4 shadow-sm">
  <div class="flex items-center justify-between gap-3">
    <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">
      Ruoli autorizzati
    </p>
    <% if (domain = @taxbranch.header_domain).present? %>
      <p class="text-xs text-slate-500">
        Fonte: <%= link_to domain.title.presence || domain.host, superadmin_domain_path(domain), class: "text-blue-600 hover:underline" %>
      </p>
    <% end %>
  </div>
  <% if @taxbranch.permission_access_roles.present? %>
    <div class="mt-2 flex flex-wrap gap-2">
      <% @taxbranch.permission_access_roles.each do |role| %>
        <span class="inline-flex items-center rounded-full bg-slate-100 px-2 py-0.5 text-xs font-medium text-slate-700">
          <%= role %>
        </span>
      <% end %>
    </div>
    <p class="mt-2 text-xs text-slate-500">
      Solo i ruoli sopra elencati possono accedere a questo ramo (oltre a superadmin e proprietari).
    </p>
  <% else %>
    <p class="mt-1 text-sm text-slate-500">
      Nessuna restrizione aggiuntiva: segue esclusivamente la visibilità del nodo.
    </p>
  <% end %>
</div>
