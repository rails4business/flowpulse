<!-- app/views/superadmin/taxbranches/_node.html.erb -->
<li
  class="flex items-center justify-between border border-slate-200 rounded-md px-2 py-1.5 bg-white shadow-sm mb-1"
  style="margin-left: <%= node.depth * 12 %>px"
>
  <!-- Info principale -->
  <div class="flex items-center gap-2 flex-1 min-w-0">
     <!-- Badge categoria -->
      
     <% dom = node.domains.first %>

      <% if dom %>
      <span class="ml-1 inline-flex items-center rounded-full bg-slate-100 px-2 py-0.5 text-[10px] font-medium text-slate-600">
      
        <%= link_to dom.host,
                    superadmin_domains_path(taxbranch_id: node.id),
                    class: "text-blue-600 hover:underline" %>
   </span>
      <% else %>
        <%# tenta eredit√† risalendo l'ancestry (metodo sul modello) %>
        <% src = node.effective_domain_taxbranch %>

        <% if src.present? %>
          <span class="ml-1 inline-flex items-center rounded-full bg-green-100 px-2 py-0.5 text-[10px] font-medium text-slate-600">
            
            <%= link_to src.display_label,
                        superadmin_domains_path(taxbranch_id: src.id),
                        class: "underline" %>
          </span>
   
    
        <% elsif node.slug_category == "brand" %>
         <span class="ml-1 inline-flex items-center rounded-full bg-slate-100 px-2 py-0.5 text-[10px] font-medium text-slate-600">
   
          <%= link_to "Ôºã Aggiungi dominio",
                      new_superadmin_domain_path(taxbranch_id: node.id),
                      class: "text-green-600 hover:underline" %>
                       </span>
        <% end %>
      <% end %>
    
 
    <span class="ml-1 inline-flex items-center rounded-full bg-slate-100 px-2 py-0.5 text-[10px] font-medium text-slate-600">
      <%= node.slug_category.presence || "‚Äî" %>
    </span>
    <!-- Etichetta -->
    <%= link_to node.slug_label,
                superadmin_taxbranch_path(node),
                class: "text-slate-800 font-medium truncate hover:underline" %>

   

    <!-- Link al post associato (se esiste) -->
    <% if node.post.present? %>
      <% published =
           if node.post.respond_to?(:status_published?)
             node.post.status_published?
           elsif node.post.respond_to?(:published?)
             node.post.published?
           else
             node.post.published_at.present?
           end %>

      <% if published %>
        <%= link_to "üìÑ",
                    post_path(node.post),
                    title: "Vedi post pubblicato",
                    class: "text-emerald-600 hover:text-emerald-700" %>
      <% else %>
        <%= link_to "üìù",
                    edit_post_path(node.post),
                    title: "Modifica bozza del post",
                    class: "text-amber-600 hover:text-amber-700" %>
      <% end %>
    <% else %>
      <%= link_to "‚ûï",
                  new_post_path(taxbranch_id: node.id),
                  title: "Crea post per questo nodo",
                  class: "text-slate-400 hover:text-blue-600" %>
    <% end %>

    <!-- Metadati -->
    <span class="text-xs text-slate-500 truncate">
      (<%= node.slug %>)
    </span>

    <% if node.description.present? %>
      <span class="text-slate-400">‚Äî</span>
      <span class="text-xs text-slate-500 truncate"><%= node.description %></span>
    <% end %>
  </div>

  <!-- Azioni -->
  <% prev      = node.higher_item %>
  <% next_node = node.lower_item  %>

  <div class="flex items-center gap-2 text-xs text-slate-500 shrink-0">
    <%= link_to "‚úèÔ∏è", edit_superadmin_taxbranch_path(node),
          class: "hover:text-blue-600", title: "Modifica categoria" %>
    <%= link_to "Ôºã Figlio",
              new_superadmin_taxbranch_path(parent_id: node.id),
              class: "hover:text-green-700", title: "Aggiungi figlio" %>

    <%= link_to "üóëÔ∏è", superadmin_taxbranch_path(node),
          data:  { turbo_method: :delete, turbo_confirm: "Sicuro di eliminare questo ramo?" },
          class: "hover:text-red-600", title: "Elimina" %>

    <span class="text-slate-300">|</span>

    <!-- Su/Gi√π nell'ordine tra i fratelli -->
    <% if prev.present? %>
      <%= link_to "‚¨Ü", move_up_superadmin_taxbranch_path(node),
            data: { turbo_method: :patch },
            class: "hover:text-slate-700", title: "Sposta su" %>
    <% else %>
      <span class="opacity-40" title="Gi√† in cima">‚¨Ü</span>
    <% end %>

    <% if next_node.present? %>
      <%= link_to "‚¨á", move_down_superadmin_taxbranch_path(node),
            data: { turbo_method: :patch },
            class: "hover:text-slate-700", title: "Sposta gi√π" %>
    <% else %>
      <span class="opacity-40" title="Gi√† in fondo">‚¨á</span>
    <% end %>

    <!-- Outdent/Indent livello -->
    <% if node.parent.present?  %>
      <%= link_to "‚¨ÖÔ∏è", move_left_superadmin_taxbranch_path(node),
            data: { turbo_method: :patch },
            class: "hover:text-slate-700", title: "Sposta a sinistra (outdent)" %>
    <% else %>
      <span class="opacity-40" title="Gi√† a radice">‚¨ÖÔ∏è</span>
    <% end %>

    <% if prev.present? %>
      <%= link_to "‚û°Ô∏è", move_right_superadmin_taxbranch_path(node),
            data: { turbo_method: :patch },
            class: "hover:text-slate-700", title: "Sposta a destra (indent)" %>
    <% else %>
      <span class="opacity-40" title="Nessun fratello precedente">‚û°Ô∏è</span>
    <% end %>
  </div>
</li>

<%# Ricorsione figli %>
<% if node.children.exists? %>
  <ul class="ml-0 mt-1 space-y-1">
    <%= render partial: "node", collection: node.children.ordered, as: :node %>
  </ul>
<% end %>
