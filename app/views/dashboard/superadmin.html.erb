<% content_for :title, "ðŸ“Š Dashboard Post" %>

<% content_for :aside do %>
  <%= render "dashboard/aside_menu"  %>
<% end %>

<%= link_to "Invita un amico",
            new_session_path(tab: 'signup', ref: Current.user.lead.username),
            class: "btn" %>

            # invitation_url = new_session_url(tab: 'signup', ref: current_user.lead.username)
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Weekplanner â€” griglia settimanale</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind = window.tailwind || {};
    tailwind.config = { theme: { extend: { colors: { pc_bg:'#f8fafc', pc_border:'#e5e7eb', pc_routine:'#93c5fd', pc_progetti:'#facc15', pc_servizi:'#86efac' }}}}
  </script>
  <style>
    .card{box-shadow:0 1px 3px rgba(0,0,0,.08),0 1px 2px rgba(0,0,0,.06)}
    .chip{padding:.15rem .4rem;border:1px solid rgba(0,0,0,.06);border-radius:.375rem;font-size:.68rem}
    .btn{padding:.25rem .5rem;border-radius:.375rem;border:1px solid #e5e7eb}
    .modal-open{overflow:hidden}
  </style>
</head>
<body class="bg-white">
<div class="max-w-[1200px] mx-auto p-4 md:p-6">
  <header class="flex items-center justify-between gap-3 mb-3">
    <h1 class="text-xl font-semibold">Planner settimanale</h1>
    <div class="flex flex-wrap items-center gap-3 text-sm">
      <label class="flex items-center gap-2"><input id="toggleGuides" type="checkbox" class="rounded" checked> Guide orarie</label>
      <div class="flex items-center gap-2">
        <span class="text-slate-500">Filtri:</span>
        <label class="flex items-center gap-1"><input type="checkbox" class="catFilter rounded" value="routine" checked> Routine</label>
        <label class="flex items-center gap-1"><input type="checkbox" class="catFilter rounded" value="progetti" checked> Progetti</label>
        <label class="flex items-center gap-1"><input type="checkbox" class="catFilter rounded" value="servizi"  checked> Servizi</label>
      </div>
      <a href="#" onclick="openLists()" class="btn hover:bg-slate-50">Apri liste âžœ</a>
    </div>
  </header>

  <div class="flex flex-wrap gap-2 text-xs mb-4">
    <span class="chip bg-pc_routine/80">Routine</span>
    <span class="chip bg-pc_progetti/80">Progetti</span>
    <span class="chip bg-pc_servizi/80">Servizi / Ruoli</span>
  </div>

  <!-- PLANNER -->
  <div id="planner" class="relative border rounded-lg overflow-x-auto overflow-hidden shadow-sm" style="border-color:#e5e7eb">
    <div id="daysHeader" class="grid" style="grid-template-columns:repeat(7,minmax(160px,1fr));"></div>
    <div id="gridBody"   class="grid" style="grid-template-columns:repeat(7,minmax(160px,1fr));"></div>
  </div>
</div>

<!-- ====== MODAL SEMPLICE SLOT ====== -->
<div id="modal" class="fixed inset-0 hidden z-50">
  <div class="absolute inset-0 bg-black/30" data-close></div>
  <div class="relative mx-auto mt-16 w-[min(880px,92vw)] bg-white rounded-xl border border-slate-200 card">
    <div class="px-4 py-3 border-b flex items-center justify-between">
      <h3 id="mTitle" class="font-semibold">Dettagli slot</h3>
      <button class="btn" data-close>âœ•</button>
    </div>
    <div class="p-4 space-y-4">
      <div id="mSummary" class="text-sm"></div>
      <div class="grid md:grid-cols-3 gap-3">
        <div class="border rounded p-3">
          <div class="font-medium mb-2">Programmi nello slot</div>
          <ul id="mPrograms" class="space-y-1 text-sm"></ul>
          <div class="mt-2 flex gap-2">
            <button class="btn" id="mAddProg">+ Nuovo programma</button>
          </div>
        </div>
        <div class="border rounded p-3">
          <div class="font-medium mb-2">Aggiungi rapido</div>
          <div class="space-y-2 text-sm">
            <div>
              <label class="block text-xs mb-1">Da Progetti</label>
              <select id="quickProject" class="w-full border rounded px-2 py-1"></select>
              <button class="btn mt-1" id="btnAddProject">â†³ Inserisci</button>
            </div>
            <div>
              <label class="block text-xs mb-1">Da Servizi</label>
              <select id="quickService" class="w-full border rounded px-2 py-1"></select>
              <button class="btn mt-1" id="btnAddService">â†³ Inserisci</button>
            </div>
            <div>
              <label class="block text-xs mb-1">Da Routine</label>
              <select id="quickRoutine" class="w-full border rounded px-2 py-1"></select>
              <button class="btn mt-1" id="btnAddRoutine">â†³ Inserisci</button>
            </div>
          </div>
        </div>
        <div class="border rounded p-3">
          <div class="font-medium mb-2">Slot</div>
          <div class="grid grid-cols-2 gap-2 text-sm">
            <label>Inizio <input id="mStart" type="time" class="w-full border rounded px-2 py-1"></label>
            <label>Fine <input id="mEnd" type="time" class="w-full border rounded px-2 py-1"></label>
            <label class="col-span-2">Tipo slot
              <select id="mType" class="w-full border rounded px-2 py-1"></select>
            </label>
            <div class="col-span-2 flex gap-2">
              <button class="btn bg-emerald-500 text-white" id="btnSaveSlot">Salva slot</button>
              <button class="btn" id="btnDeleteSlot">Elimina slot</button>
            </div>
          </div>
        </div>
      </div>
      <div class="text-xs text-slate-500">Le liste (Progetti, Servizi, Routine, Tipi slot, Obiettivi) si gestiscono in <strong>liste.html</strong>.</div>
    </div>
  </div>
</div>

<script>
  // ======= STORAGE chiavi condivise con liste.html =======
  const K = {
    schedule:'weekplanner:v1',
    objectives:'weekplanner:objectives',
    projects:'weekplanner:projects',
    services:'weekplanner:services',
    routines:'weekplanner:routines',
    slotTypes:'weekplanner:slot_types'
  };

  // seed
  const DEFAULT_PROJECTS = [
    { id:"p1", name:"Igiene Posturale â€” corso online" },
    { id:"p2", name:"PosturaCorretta alla scrivania" }
  ];
  const DEFAULT_SERVICES = [
    { id:"s1", role:"Tutor", step:"Presentazione", service:"Gruppo Igiene Posturale" }
  ];
  const DEFAULT_ROUTINES = [
    { id:"r1", name:"MobilitÃ  mattina", description:"10' mobilitÃ  + 5' respiro" },
    { id:"r2", name:"Scrittura focus", description:"15' journaling + 15' pianificazione" }
  ];
  const DEFAULT_SLOT_TYPES = [
    { id:"st1", name:"salute" },
    { id:"st2", name:"lavoro" },
    { id:"st3", name:"formazione" },
    { id:"st4", name:"tempo libero" }
  ];

  const DEFAULT_DATA = {
    dayStart:"08:00", dayEnd:"22:00", pxPerMinute:1,
    days:[ {name:"LunedÃ¬", slots:[]}, {name:"MartedÃ¬", slots:[]}, {name:"MercoledÃ¬", slots:[]}, {name:"GiovedÃ¬", slots:[]}, {name:"VenerdÃ¬", slots:[]}, {name:"Sabato", slots:[]}, {name:"Domenica", slots:[]} ],
    categoryStyles:{ routine:"bg-pc_routine", progetti:"bg-pc_progetti", servizi:"bg-pc_servizi" },
    slotTypeStyles:{ salute:"border-emerald-300", lavoro:"border-amber-300", servizi:"border-sky-300", formazione:"border-purple-300", "tempo libero":"border-lime-300", default:"border-slate-300" }
  };

  function load(key, fallback){ const raw = localStorage.getItem(key); try { return raw? JSON.parse(raw): fallback } catch { return fallback } }
  function save(key, val){ localStorage.setItem(key, JSON.stringify(val)) }

  let scheduleData = load(K.schedule, structuredClone(DEFAULT_DATA));
  let projects     = load(K.projects, structuredClone(DEFAULT_PROJECTS));
  let services     = load(K.services, structuredClone(DEFAULT_SERVICES));
  let routines     = load(K.routines, structuredClone(DEFAULT_ROUTINES));
  let slotTypes    = load(K.slotTypes, structuredClone(DEFAULT_SLOT_TYPES));

  // ======= utils =======
  const $H = id=>document.getElementById(id);
  const $daysHeader = $H('daysHeader');
  const $gridBody = $H('gridBody');
  const START = toMin(scheduleData.dayStart); const END = toMin(scheduleData.dayEnd); const PXPM = scheduleData.pxPerMinute || 1; const H = (END-START)*PXPM;
  function toMin(t){ const [h,m]=t.split(':').map(Number); return h*60+m }
  function minutesToTime(min){ const h=Math.floor(min/60), m=min%60; return String(h).padStart(2,'0')+':'+String(m).padStart(2,'0') }
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  function isTime(t){ return /^\d{2}:\d{2}$/.test(t) }

  function renderHeader(){ $daysHeader.innerHTML = scheduleData.days.map(d=>`<div class="bg-slate-50 text-center text-sm font-medium py-2">${d.name}</div>`).join('') }

  function hourScale(show=true){ if(!show) return ''; const rows=[]; for(let m=START; m<=END; m+=60){ const top=(m-START)*PXPM; if(m<END){ rows.push(`<div class=\"absolute left-0 w-full border-t border-slate-200/30\" style=\"top:${top}px\"></div>`) } } return `<div class=\"pointer-events-none absolute inset-0\">${rows.join('')}</div>` }

  function slotFillPercent(slot){ const s=toMin(slot.start), e=toMin(slot.end), dur=Math.max(0,e-s); const covered=(slot.items||[]).reduce((a,it)=>{const is=clamp(toMin(it.start),s,e); const ie=clamp(toMin(it.end),s,e); return a+Math.max(0,ie-is)},0); return Math.min(100, Math.round((covered/dur)*100)) }

  function renderSlot(slot, di){
    const s=toMin(slot.start), e=toMin(slot.end); const top=(s-START)*PXPM, h=Math.max(28,(e-s)*PXPM)-1; const border = scheduleData.slotTypeStyles[slot.slot_type] || scheduleData.slotTypeStyles.default; const fill=slotFillPercent(slot); const statusCls = fill>=95 ? 'bg-emerald-500' : 'bg-rose-500';
    const inner = (slot.items||[]).sort((a,b)=>toMin(a.start)-toMin(b.start)).map(it=>{ const is=toMin(it.start), ie=toMin(it.end); const itTop=Math.max(0,(is-s)*PXPM), itH=Math.max(18,(Math.min(ie,e)-Math.max(is,s))*PXPM)-1; const catCls=scheduleData.categoryStyles[it.category]||'bg-slate-200'; return `<div class=\"absolute left-1 right-1 ${catCls} border border-white/60 rounded-sm p-1 card\" style=\"top:${itTop}px;height:${itH}px\"><div class=\"text-[11px] font-semibold\">${it.start}â€“${it.end}</div><div class=\"text-[12px]\">${it.title}</div></div>` }).join('')
    return `<div class=\"absolute left-1 right-1 bg-pc_bg border ${border} rounded-md card cursor-pointer\" data-slot=\"${slot.id}\" data-di=\"${di}\" style=\"top:${top}px;height:${h}px\"><div class=\"px-2 py-1 border-b border-slate-200/40 text-[12px] flex items-center justify-between\"><span class=\"font-medium flex items-center gap-2\"><span class=\"inline-block w-2 h-2 rounded-full ${statusCls}\"></span>${slot.start}â€“${slot.end}</span><span class=\"uppercase tracking-wide text-[10px] text-slate-500\">${slot.slot_type||'slot'} â€¢ <span class=\"text-slate-400\">${fill}%</span></span></div><div class=\"relative w-full overflow-hidden\" style=\"height:calc(100% - 28px)\">${inner}</div></div>`
  }

  function renderDay(day, di, showGuides){ const slots=(day.slots||[]).sort((a,b)=>toMin(a.start)-toMin(b.start)).map(s=>renderSlot(s, di)).join(''); return `<div class=\"relative bg-white overflow-hidden\" style=\"height:${H}px\">${hourScale(showGuides)}${slots}</div>` }

  function drawPlanner(){ const show = document.getElementById('toggleGuides').checked; $gridBody.innerHTML = scheduleData.days.map((d,i)=>renderDay(d,i,show)).join('') }

  // click slot â†’ modal
  $gridBody.addEventListener('click', e=>{ const el=e.target.closest('[data-slot]'); if(!el) return; openSlotModal(+el.dataset.di, el.dataset.slot) })

  // modal
  const $modal=document.getElementById('modal');
  $modal.addEventListener('click', e=>{ if(e.target.hasAttribute('data-close')) closeModal() })
  function openModal(){ $modal.classList.remove('hidden'); document.body.classList.add('modal-open') }
  function closeModal(){ $modal.classList.add('hidden'); document.body.classList.remove('modal-open') }

  let cur = { di:null, sid:null }

  function openSlotModal(di, sid){
    cur = {di, sid}; const day=scheduleData.days[di]; const slot=day.slots.find(s=>s.id===sid); const fill=slotFillPercent(slot);
    document.getElementById('mTitle').textContent = `${day.name} â€” ${slot.start}â€“${slot.end}`
    document.getElementById('mStart').value = slot.start; document.getElementById('mEnd').value = slot.end;
    // tipi slot
    const selType=document.getElementById('mType'); selType.innerHTML = slotTypes.map(t=>`<option ${t.name===slot.slot_type?'selected':''}>${t.name}</option>`).join('');
    document.getElementById('mSummary').innerHTML = `<span class=\"chip ${fill>=95?'bg-emerald-100 border-emerald-300':'bg-rose-100 border-rose-300'}\">${fill}% occupato</span> <span class=\"chip\">Programmi: ${(slot.items||[]).length}</span>`
    // programmi
    const list=document.getElementById('mPrograms'); list.innerHTML = (slot.items||[]).sort((a,b)=>toMin(a.start)-toMin(b.start)).map(it=>`<li class=\"flex items-center justify-between border rounded px-2 py-1\"><span class=\"text-sm\"><strong>${it.start}â€“${it.end}</strong> â€” ${it.title} <em class=\"text-slate-500\">(${it.category})</em></span><button class=\"btn text-red-600\" data-del-prog=\"${it.id}\">âˆ’</button></li>`).join('') || '<div class="text-sm text-slate-500">â€” Nessun programma â€”</div>'
    list.querySelectorAll('[data-del-prog]').forEach(b=> b.onclick=()=>{ slot.items = (slot.items||[]).filter(x=>x.id!==b.dataset.delProg); persist() ; openSlotModal(di, sid) })

    // quick selectors
    document.getElementById('quickProject').innerHTML = `<option value="">â€” scegli â€”</option>` + projects.map(p=>`<option value="${p.id}">${p.name}</option>`).join('')
    document.getElementById('quickService').innerHTML = `<option value="">â€” scegli â€”</option>` + services.map(s=>`<option value="${s.id}">${s.role} â€¢ ${s.step} â€¢ ${s.service}</option>`).join('')
    document.getElementById('quickRoutine').innerHTML = `<option value="">â€” scegli â€”</option>` + routines.map(r=>`<option value="${r.id}">${r.name} â€” ${r.description}</option>`).join('')

    document.getElementById('btnAddProject').onclick = ()=>{ const id=document.getElementById('quickProject').value; const p=projects.find(x=>x.id===id); if(!p) return; quickAdd(di, sid, {category:'progetti', title:p.name}) }
    document.getElementById('btnAddService').onclick = ()=>{ const id=document.getElementById('quickService').value; const s=services.find(x=>x.id===id); if(!s) return; quickAdd(di, sid, {category:'servizi', title:`${s.role} â€¢ ${s.step} â€¢ ${s.service}`}) }
    document.getElementById('btnAddRoutine').onclick = ()=>{ const id=document.getElementById('quickRoutine').value; const r=routines.find(x=>x.id===id); if(!r) return; quickAdd(di, sid, {category:'routine', title:r.name, note:r.description}) }

    document.getElementById('mAddProg').onclick = ()=>{ quickAdd(di, sid, {category:'servizi', title:'Nuovo programma'}) }

    document.getElementById('btnSaveSlot').onclick = ()=>{
      let st=document.getElementById('mStart').value, en=document.getElementById('mEnd').value, tp=document.getElementById('mType').value; if(!isTime(st)||!isTime(en)||toMin(st)>=toMin(en)) { alert('Orari non validi'); return }
      slot.start=st; slot.end=en; slot.slot_type=tp; persist(); closeModal(); drawPlanner();
    }
    document.getElementById('btnDeleteSlot').onclick = ()=>{ day.slots = day.slots.filter(s=>s.id!==sid); persist(); closeModal(); drawPlanner(); }

    openModal();
  }

  function quickAdd(di, sid, {category,title,note=''}){ const day=scheduleData.days[di]; const slot=day.slots.find(s=>s.id===sid); const s=toMin(slot.start), e=toMin(slot.end); const lastEnd=(slot.items||[]).map(it=>toMin(it.end)).sort((a,b)=>b-a)[0] || s; const st=minutesToTime(clamp(lastEnd, s, e-15)); const en=minutesToTime(clamp(lastEnd+30, s+15, e)); slot.items=slot.items||[]; slot.items.push({ id:crypto.randomUUID(), category, title, note, start:st, end:en }); persist(); openSlotModal(di, sid); drawPlanner(); }

  // crea/aggiungi slot veloce con doppio click sulla colonna (quality of life)
  $gridBody.addEventListener('dblclick', e=>{
    const col = Array.from($gridBody.children).indexOf(e.target.closest('div'));
    if(col<0) return; const y=e.offsetY; const m = START + Math.round(y/PXPM/15)*15; const st=minutesToTime(clamp(m, START, END-30)); const en=minutesToTime(clamp(m+60, START+30, END));
    const d=scheduleData.days[col]; d.slots=d.slots||[]; d.slots.push({ id:crypto.randomUUID(), start:st, end:en, slot_type: (slotTypes[0]?.name || 'servizi'), items:[] }); persist(); drawPlanner();
  })

  function persist(){ save(K.schedule, scheduleData) }

  // top bar
  document.getElementById('toggleGuides').addEventListener('change', drawPlanner)

  function openLists(){ alert('Apri il file liste.html in unâ€™altra scheda/finestra per gestire le liste. Entrambi condividono i dati tramite localStorage.') }

  // initial paint
  renderHeader(); drawPlanner();
</script>
</body>
</html>

